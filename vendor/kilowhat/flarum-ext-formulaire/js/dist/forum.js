(()=>{var t={n:i=>{var e=i&&i.__esModule?()=>i.default:()=>i;return t.d(e,{a:e}),e},d:(i,e)=>{for(var r in e)t.o(e,r)&&!t.o(i,r)&&Object.defineProperty(i,r,{enumerable:!0,get:e[r]})},o:(t,i)=>Object.prototype.hasOwnProperty.call(t,i),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},i={};(()=>{"use strict";t.r(i),t.d(i,{components:()=>ee,extend:()=>ne,fields:()=>re,pages:()=>oe});const e=flarum.core.compat["forum/app"];var r=t.n(e);const o=flarum.core;function n(t,i){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},n(t,i)}function a(t,i){t.prototype=Object.create(i.prototype),t.prototype.constructor=t,n(t,i)}const s=flarum.core.compat["common/Model"];var l=t.n(s),u=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).filename=l().attribute("filename"),i.humanSize=l().attribute("humanSize"),i.url=l().attribute("url"),i}return a(i,t),i}(l());const d=flarum.core.compat["common/components/Badge"];var c=t.n(d);const f=flarum.core.compat["common/utils/ItemList"];var h=t.n(f);const p=flarum.core.compat["common/utils/computed"];var g=t.n(p),v=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).seoId=l().attribute("seoId"),i.link_type=l().attribute("link_type"),i.link_id=l().attribute("link_id"),i.slug=l().attribute("slug"),i.title=l().attribute("title"),i.private_title=l().attribute("private_title"),i.template=l().attribute("template"),i.accept_submissions=l().attribute("accept_submissions"),i.allow_modification=l().attribute("allow_modification"),i.max_submissions=l().attribute("max_submissions"),i.submission_count=l().attribute("submission_count"),i.send_confirmation_to_participants=l().attribute("send_confirmation_to_participants"),i.notify_emails=l().attribute("notify_emails"),i.web_confirmation_message=l().attribute("web_confirmation_message"),i.confirmationMessageHtml=l().attribute("confirmationMessageHtml"),i.email_confirmation_message=l().attribute("email_confirmation_message"),i.email_notification_message=l().attribute("email_notification_message"),i.email_confirmation_title=l().attribute("email_confirmation_title"),i.email_notification_title=l().attribute("email_notification_title"),i.automatic_discussion_options=l().attribute("automatic_discussion_options"),i.permission_see_own=l().attribute("permission_see_own"),i.permission_see_any=l().attribute("permission_see_any"),i.permission_edit_own=l().attribute("permission_edit_own"),i.permission_edit_any=l().attribute("permission_edit_any"),i.show_on_creation=l().attribute("show_on_creation"),i.isHidden=l().attribute("isHidden"),i.user=l().hasOne("user"),i.type=g()("link_type",(function(t){return"groups"===t?"user":"tags"===t?"discussion":"standalone"})),i.isAutoLink=g()("type","automatic_discussion_options",(function(t,i){return"discussion"===t&&i&&i.enabled})),i}a(i,t);var e=i.prototype;return e.badges=function(){var t=new(h());return this.isHidden()&&t.add("hidden",c().component({type:"hidden",icon:"fas fa-trash",label:r().translator.trans("kilowhat-formulaire.forum.badge.hidden")})),t},e.apiEndpoint=function(){return"/formulaire/forms"+(this.exists?"/"+this.data.id:"")},i}(l()),b=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).formData=l().attribute("data"),i.isLocked=l().attribute("isLocked"),i.isHidden=l().attribute("isHidden"),i.createdAt=l().attribute("createdAt"),i.user=l().hasOne("user"),i.form=l().hasOne("form"),i}a(i,t);var e=i.prototype;return e.badges=function(){var t=new(h());return this.isLocked()&&t.add("lock",c().component({type:"lock",icon:"fas fa-lock",label:r().translator.trans("kilowhat-formulaire.forum.badge.locked")})),this.isHidden()&&t.add("hidden",c().component({type:"hidden",icon:"fas fa-trash",label:r().translator.trans("kilowhat-formulaire.forum.badge.hidden")})),t},e.apiEndpoint=function(){return"/formulaire/submissions"+(this.exists?"/"+this.data.id:"")},i}(l());const y=flarum.core.compat["common/components/Page"];var w=t.n(y);const F=flarum.core.compat["common/components/Button"];var _=t.n(F);const k=flarum.core.compat["common/components/LinkButton"];var x=t.n(k);const E=flarum.core.compat["common/components/LoadingIndicator"];var C=t.n(E);const S=flarum.core.compat["common/components/Placeholder"];var I=t.n(S);const A=flarum.core.compat["common/helpers/listItems"];var N=t.n(A);const P=flarum.core.compat["common/helpers/icon"];var T=t.n(P);const O=flarum.core.compat["common/components/Modal"];var D=t.n(O);const L=flarum.core.compat["common/utils/withAttr"];var M=t.n(L);function B(t){return r().route("formulaireFormShow",{id:t.seoId()})}function R(t){return r().route("formulaireFormEdit",{id:t.id()})}function H(t){return r().route("formulaireSubmissionIndex",{id:t.id()})}function V(t){return r().route("formulaireSubmission",{id:t.id()})}function q(t,i){return r().route("formulaireProfile",{username:t.username(),form:i.seoId()})}var U="kilowhat-formulaire.forum.form-create.",j=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).formTitle="",i.dirty=!1,i}a(i,t);var e=i.prototype;return e.className=function(){return"FormulaireModal FormulaireTheme Modal--small"},e.title=function(){return r().translator.trans(U+"title")},e.content=function(){var t=this;return m(".Modal-body",[m(".Form-group",[m("label",r().translator.trans(U+"field.title")),m("input.FormControl",{type:"text",value:this.formTitle,oninput:M()("value",(function(i){t.formTitle=i,t.dirty=!0}))})]),m(".ButtonGroup",[_().component({type:"submit",className:"Button Button--primary",loading:this.loading,disabled:!this.dirty},r().translator.trans(U+"button.create"))])])},e.onsubmit=function(t){t.preventDefault(),this.loading=!0,r().store.createRecord("formulaire-forms").save({title:this.formTitle,private_title:this.formTitle,link_type:this.attrs.linkType,accept_submissions:null===this.attrs.linkType},{errorHandler:this.onerror.bind(this)}).then((function(t){r().modal.close(),m.route.set(R(t))}))},i}(D());const G=flarum.core.compat["forum/components/IndexPage"];var z=t.n(G),W=function(){function t(){}return t.prototype.view=function(t){var i=".FormulairePage"+(t.attrs.noTheme?"":".FormulaireTheme"),e=t.attrs,r=e.showSideNav,o=void 0===r||r,n=e.narrow,a=void 0!==n&&n;return o?m(".FormulairePageContainer",m(".container",m(".sideNavContainer",[m("nav.IndexPage-nav.sideNav",m("ul",N()(z().prototype.sidebarItems().toArray()))),m(".sideNavOffset",m(i,t.children))]))):m(".FormulairePageContainer.FormulairePageContainer--noSideNav",{className:a?"FormulairePageContainer--narrow":""},m(".container",m(i,t.children)))},t}(),J=function(){function t(t){void 0===t&&(t={}),this.params=void 0,this.forms=[],this.moreResults=!1,this.loading=!0,this.params=t}var i=t.prototype;return i.requestParams=function(){var t={filter:{}};return t.sort=this.sortMap()[this.params.sort],this.params.q&&(t.filter.q=this.params.q),t},i.sortMap=function(){return{latest:"-createdAt",oldest:"createdAt"}},i.clear=function(){this.forms=[],m.redraw()},i.refresh=function(t){var i=this,e=(void 0===t?{}:t).deferClear,r=void 0!==e&&e;return this.loading=!0,r||this.clear(),this.loadResults().then((function(t){i.forms=[],i.parseResults(t)}),(function(){i.loading=!1,m.redraw()}))},i.loadResults=function(t){void 0===t&&(t=0);var i=r().preloadedApiDocument();if(i)return Promise.resolve(i);var e=this.requestParams();return e.page={offset:t},r().store.find("formulaire/forms",e)},i.loadMore=function(){this.loading=!0,this.loadResults(this.forms.length).then(this.parseResults.bind(this))},i.parseResults=function(t){var i;return(i=this.forms).push.apply(i,t),this.loading=!1,this.moreResults=!!t.payload.links&&!!t.payload.links.next,m.redraw(),t},t}();const K=flarum.core.compat["common/components/Dropdown"];var X=t.n(K);const Y=flarum.core.compat["common/utils/extractText"];var Q=t.n(Y),Z=function(){function t(){}return t.prototype.view=function(t){var i={};["latest","oldest"].forEach((function(t){i[t]=Q()(r().translator.trans("kilowhat-formulaire.forum.form-sort."+t))}));var e=t.attrs.sort||Object.keys(i)[0];return m(X(),{buttonClassName:"Button",label:i[t.attrs.sort]||Object.keys(i).map((function(t){return i[t]}))[0],icon:"fas fa-sort-amount-"+("latest"===e?"up":"down")},Object.keys(i).map((function(r){var o=i[r],n=e===r;return m(_(),{icon:!n||"fas fa-check",onclick:function(){t.attrs.onchange(r)},active:n},o)})))},t}();function $(t){return(t.submission_count()||"0")+(t.max_submissions()?"/"+t.max_submissions():"")}function tt(){return tt=Object.assign?Object.assign.bind():function(t){for(var i=1;i<arguments.length;i++){var e=arguments[i];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},tt.apply(this,arguments)}const it=flarum.core.compat["common/components/Separator"];var et=t.n(it);const rt=flarum.core.compat["common/models/Group"];var ot=t.n(rt);const nt=flarum.core.compat["common/components/GroupBadge"];var at=t.n(nt),st="kilowhat-formulaire.forum.permission-controls.";function lt(t){var i=r().store.getById("groups",t);return i?at().component({group:i,label:null}):""}var ut=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).attrs=void 0,i}a(i,t),i.initAttrs=function(i){t.initAttrs.call(this,i),i.className="PermissionDropdown",i.buttonClassName="Button Button--text"};var e=i.prototype;return e.view=function(i){var e=this,o=[],n=this.attrs.groupIds,a=null===n,s=n&&-1!==n.indexOf(ot().GUEST_ID),l=n&&-1!==n.indexOf(ot().MEMBER_ID),u=r().store.getById("groups",ot().ADMINISTRATOR_ID);return this.attrs.label=a?c().component({icon:"fas fa-angle-double-down"}):s?c().component({icon:"fas fa-globe"}):l?c().component({icon:"fas fa-user"}):[lt(ot().ADMINISTRATOR_ID),n.map(lt)],this.showing&&(this.attrs.disallowInherit||o.push(m(_(),{icon:!a||"fas fa-check",onclick:function(){return e.save(null)}},[c().component({icon:"fas fa-angle-double-down"})," ",r().translator.trans(st+"inherit")])),this.attrs.allowGuest&&o.push(m(_(),{icon:!s||"fas fa-check",onclick:function(){return e.save([ot().GUEST_ID])},disabled:this.isGroupDisabled(ot().GUEST_ID)},[c().component({icon:"fas fa-globe"})," ",r().translator.trans(st+(this.attrs.guestMeansDisabled?"disabled_members_button":"everyone_button"))])),o.push(m(_(),{icon:!l||"fas fa-check",onclick:function(){return e.save([ot().MEMBER_ID])},disabled:this.isGroupDisabled(ot().MEMBER_ID)},[c().component({icon:"fas fa-user"})," ",r().translator.trans(st+"members_button")]),et().component(),m(_(),{icon:!!(a||s||l)||"fas fa-check",disabled:!a&&!s&&!l,onclick:function(t){t.shiftKey&&t.stopPropagation(),e.save([])}},[lt(u.id())," ",u.namePlural()])),[].push.apply(o,r().store.all("groups").filter((function(t){return-1===[ot().ADMINISTRATOR_ID,ot().GUEST_ID,ot().MEMBER_ID].indexOf(t.id())})).map((function(t){return m(_(),{icon:!n||-1===n.indexOf(t.id())||"fas fa-check",onclick:function(i){i.shiftKey&&i.stopPropagation(),e.toggle(t.id())},disabled:e.isGroupDisabled(t.id())&&e.isGroupDisabled(ot().MEMBER_ID)&&e.isGroupDisabled(ot().GUEST_ID)},[lt(t.id())," ",t.namePlural()])})))),t.prototype.view.call(this,tt({},i,{children:o}))},e.save=function(t){this.attrs.onchange(t)},e.toggle=function(t){var i=this.attrs.groupIds||[],e=i.indexOf(t);-1!==e?i.splice(e,1):(i.push(t),i=i.filter((function(t){return-1===[ot().GUEST_ID,ot().MEMBER_ID].indexOf(t)}))),this.save(i)},e.isGroupDisabled=function(t){return!1},i}(X()),mt="kilowhat-formulaire.forum.global-settings.",dt=function(){function t(){}return t.prototype.view=function(t){var i=[["formulaire.fill","fill",!0]];switch(t.attrs.type){case"discussion":i=[["discussion.seeOwnFormulaire","seeOwnDiscussion",!1],["discussion.seeAnyFormulaire","seeAnyDiscussion",!0],["discussion.editOwnFormulaire","editOwnDiscussion",!1],["discussion.editAnyFormulaire","editAnyDiscussion",!1]];break;case"user":i=[["formulaire.seeOwnUser","seeOwnUser",!0],["formulaire.seeAnyUser","seeAnyUser",!0],["formulaire.editOwnUser","editOwnUser",!0],["formulaire.editAnyUser","editAnyUser",!1]]}var e="true"===localStorage.getItem("formulaireHideGlobalSettings"),o=!!r().forum.attribute("adminUrl");return m(".FormulaireGlobalSettings",[m("h3",{onclick:function(){e?localStorage.removeItem("formulaireHideGlobalSettings"):localStorage.setItem("formulaireHideGlobalSettings","true")}},[r().translator.trans(mt+"title")," ",T()("fas fa-chevron-"+(e?"down":"up")),o?null:[" ",m("em",r().translator.trans(mt+"admin-only"))]]),e?null:i.map((function(t){return m(".Form-group.FormulairePermissionFormGroup",[m("label",r().translator.trans(mt+"permissions."+t[1])),ut.component({groupIds:r().forum.attribute("formulaireGlobalPermissions")[t[0]],onchange:function(i){r().forum.attribute("formulaireGlobalPermissions")[t[0]]=i,r().request({method:"POST",url:r().forum.attribute("apiUrl")+"/permission",body:{permission:t[0],groupIds:i}})},disabled:!o,allowGuest:t[2],guestMeansDisabled:t[2]&&-1!==t[0].indexOf("Own"),disallowInherit:!0})])}))])},t}(),ct=function(){function t(){this.value="",this.activeValue="",this.debounce=0}var i=t.prototype;return i.oninit=function(t){this.value=t.attrs.initialValue,this.activeValue=this.value},i.view=function(t){var i=this;return m(".Search",m(".Search-input",[m("input.FormControl",{type:"search",value:this.value,oninput:function(e){i.value=e.target.value,clearTimeout(i.debounce),i.debounce=setTimeout((function(){i.activeValue=i.value,t.attrs.onchange(i.value),m.redraw()}),300)},placeholder:t.attrs.placeholder}),this.activeValue?m("button.Search-clear.Button.Button--icon.Button--link",{type:"button",onclick:function(){i.value="",i.activeValue="",t.attrs.onchange("")}},T()("fas fa-times-circle")):null]))},t}(),ft="kilowhat-formulaire.forum.form-index.",ht=[{key:"standalone",icon:"fas fa-poll-h",route:"formulaireFormIndex"},{key:"discussion",icon:"fas fa-comment-alt",route:"formulaireFormIndexDiscussion"},{key:"user",icon:"fas fa-user-tag",route:"formulaireFormIndexUser"}],pt=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).formType=void 0,i.formList=void 0,i.attrs=void 0,i}a(i,t);var e=i.prototype;return e.oninit=function(i){switch(t.prototype.oninit.call(this,i),this.attrs.routeName){case"formulaireFormIndexDiscussion":this.formType="discussion";break;case"formulaireFormIndexUser":this.formType="user";break;default:this.formType="standalone"}this.formList=new J({q:"type:"+this.formType}),this.formList.refresh()},e.view=function(){var t=this;return m(W,[m(".FormulaireHeader.FormulaireHeader--banner",[T()("fas fa-poll-h",{className:"FormulaireBanner"}),m("h1",r().translator.trans(ft+"header.title")),m("ul.FormulaireHeaderLinks",[m("li",m("a",{target:"_blank",href:"https://kilowhat.net/flarum/extensions/formulaire"},[r().translator.trans(ft+"header.documentation")," ",T()("fas fa-external-link-alt")])),m("li",m("a",{target:"_blank",href:"https://discuss.flarum.org/d/23063"},[r().translator.trans(ft+"header.discuss")," ",T()("fas fa-external-link-alt")]))]),m(".FormulaireTabs",ht.map((function(i){return x().component({className:t.formType===i.key?"active":"",icon:i.icon,href:r().route(i.route)},r().translator.trans(ft+"tabs."+i.key))})))]),m(dt,{type:this.formType}),m(".FormulaireFilters",[m(Z,{sort:this.formList.params.sort,onchange:function(i){t.formList.params.sort=i,t.formList.refresh()}}),m(ct,{initialValue:"",onchange:function(i){t.formList.params.q="type:"+t.formType+" "+i,t.formList.refresh()},placeholder:r().translator.trans(ft+"search")}),_().component({className:"Button Button--primary FormulaireFilters--right",icon:"fas fa-plus",onclick:function(){r().modal.show(j,{linkType:"discussion"===t.formType?"tags":"user"===t.formType?"groups":null})}},r().translator.trans(ft+"new"))]),this.list(this.formList)])},e.list=function(t){var i,e=this;return t.loading?i=C().component():t.moreResults&&(i=_().component({className:"Button",onclick:t.loadMore.bind(t)},r().translator.trans(ft+"load-more"))),0!==t.forms.length||t.loading?m("div",[m("table.FormulaireDataTable",[m("thead",m("tr",[m("th",r().translator.trans(ft+"columns.title")),"standalone"===this.formType?[m("th",r().translator.trans(ft+"columns.accept-submissions")),m("th",r().translator.trans(ft+"columns.allow-modification"))]:[m("th",r().translator.trans(ft+"columns.enabled"))],m("th",r().translator.trans(ft+"columns.submissions")),m("th",r().translator.trans(ft+"columns.actions"))])),m("tbody",t.forms.map((function(t){var i=t.badges().toArray();return m("tr",[m("td",[t.private_title(),i.length?m("ul.FormulaireDataTable-badges.badges",N()(i)):null]),m("td",t.accept_submissions()?T()("fas fa-check"):null),"standalone"===e.formType?m("td",t.allow_modification()?T()("fas fa-check"):null):null,m("td",$(t)),m("td",[x().component({className:"Button",href:R(t)},r().translator.trans(ft+"edit"))," ",x().component({className:"Button",href:B(t)},r().translator.trans(ft+"show"))," ",x().component({className:"Button",href:H(t)},r().translator.trans(ft+"submissions"))])])})))]),i]):I().component({text:r().translator.trans(ft+"empty")})},i}(w()),gt=function(){function t(){this.sortingIndex=null,this.showPlaceholderForIndex=0,this.dragoverenterhandler=void 0,this.drophandler=void 0}var i=t.prototype;return i.oncreate=function(t){var i=this;this.dragoverenterhandler=function(e){if(null!==i.sortingIndex){e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="move";var r=0;t.dom.childNodes.forEach((function(i){var o=parseInt(i.dataset.index||"");if(!isNaN(o)){var n=i.getBoundingClientRect();if("horizontal"===t.attrs.direction){if(!n.width)return;var a=n.left+n.width/2;e.pageX>a+window.scrollX&&(r=o+1)}else{if(!n.height)return;var s=n.top+n.height/2;e.pageY>s+window.scrollY&&(r=o+1)}}})),r!==i.showPlaceholderForIndex&&(i.showPlaceholderForIndex=r,m.redraw())}},document.addEventListener("dragover",this.dragoverenterhandler),document.addEventListener("dragenter",this.dragoverenterhandler),this.drophandler=function(e){if(null!==i.sortingIndex){e.preventDefault(),e.stopPropagation();var r=i.sortingIndex,o=i.showPlaceholderForIndex-(i.showPlaceholderForIndex>i.sortingIndex?1:0);i.sortingIndex=null,m.redraw(),o!==r&&t.attrs.onsort(r,o)}},document.addEventListener("drop",this.drophandler)},i.onremove=function(){document.removeEventListener("dragover",this.dragoverenterhandler),document.removeEventListener("dragenter",this.dragoverenterhandler),document.removeEventListener("drop",this.drophandler)},i.view=function(t){var i=this,e=[];t.children.forEach((function(r,o){null!==i.sortingIndex&&i.showPlaceholderForIndex===o&&e.push(i.placeholder(t)),o===i.sortingIndex&&(r.attrs.style||(r.attrs.style={}),r.attrs.style.display="none"),r.attrs["data-index"]=o,r.attrs.ondragstart=function(i){if(i.target&&i.dataTransfer){for(var e=i.target.parentNode;e&&e!==this;){if(e instanceof HTMLElement&&e.classList.contains("js-sortable-container"))return void(i.redraw=!1);e=e.parentNode}var r=t.attrs.handleClassName;if(void 0===r&&(r="js-handle"),r&&!i.target.classList.contains(r)||t.attrs.disabled)i.redraw=!1;else{var n=Array.from(t.dom.childNodes).find((function(t){return t.dataset.index===o+""}));if(!n)return;var a=n.getBoundingClientRect();i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",o+""),i.dataTransfer.setDragImage(n,i.pageX-a.left-window.scrollX,i.pageY-a.top-window.scrollY),t.state.sortingIndex=o,t.state.showPlaceholderForIndex=o}}else i.redraw=!1},e.push(r)})),null!==this.sortingIndex&&this.showPlaceholderForIndex===t.children.length&&e.push(this.placeholder(t));var r={className:"js-sortable-container"};return t.attrs.className&&(r.className+=" "+t.attrs.className),m(t.attrs.containerTag||"div",r,e)},i.placeholder=function(t){return m(t.attrs.placeholderTag||"div",{className:"FormulaireSortablePlaceholder",key:"placeholder"},"tr"===t.attrs.placeholderTag?m("td",{colspan:100}):null)},t}();const vt=flarum.core.compat["common/components/Switch"];var bt=t.n(vt);const yt=flarum.core.compat["common/components/Select"];var wt=t.n(yt),Ft=function(){function t(){}return t.prototype.view=function(t){var i=t.attrs.errors||[];return"object"!=typeof i||Array.isArray(i)||(i=i.errors||[]),i&&i.length?m("ul.FormulaireValidationErrors",i.map((function(t){return m("li",t)}))):m("div")},t}(),_t=function(){function t(){}return t.prototype.view=function(t){var i=t.attrs.validationErrors||[];return"object"!=typeof i||Array.isArray(i)||(i=i.errors||[]),m(".Form-group.Formulaire-form-group",{className:(i&&i.length?"in-error":"")+(t.attrs.className?" "+t.attrs.className:"")},[m(".Form-group-label",[t.attrs.label,t.attrs.description?m("p",t.attrs.description):null]),m(".Form-group-field",[t.children,m(Ft,{errors:i})])])},t}(),kt=function(){function t(){}return t.prototype.view=function(t){var i={className:(t.attrs.className?t.attrs.className+" ":"")+"js-handle"};return t.attrs.disabled?i.className+=" disabled":i.draggable="true",m(t.attrs.elementTag||"div",i,T()("fas fa-grip-lines"))},t}(),xt="kilowhat-formulaire.forum.template-editor.",Et=function(){function t(t){var i=t.config,e=void 0===i?{}:i,r=t.submission,o=void 0===r?{}:r,n=t.uploader,a=void 0===n?null:n,s=t.onchange,l=void 0===s?function(){}:s,u=t.onduplicate,m=void 0===u?function(){}:u,d=t.ondelete,c=void 0===d?function(){}:d,f=t.disabled,h=void 0!==f&&f,p=t.validationErrors,g=void 0===p?{}:p,v=t.depth,b=void 0===v?0:v,y=t.expertMode,w=void 0!==y&&y;this.config=void 0,this.submission=void 0,this.uploader=void 0,this.onchange=void 0,this.onduplicate=void 0,this.ondelete=void 0,this.disabled=void 0,this.validationErrors=void 0,this.depth=void 0,this.expertMode=void 0,this.config=e,this.submission=o,this.uploader=a,this.onchange=l,this.onduplicate=m,this.ondelete=c,this.disabled=h,this.validationErrors=g,this.depth=b,this.expertMode=w,Object.keys(this.config).length&&qt(this.config)}var i=t.prototype;return i.getConfig=function(t,i){return void 0===i&&(i=""),this.config[t]||i},i.uniqueFieldId=function(){return"formulaireField"+this.getConfig("unique")},i.setConfig=function(t){var i=this;return function(e){null===e||!1===e||""===e?delete i.config[t]:i.config[t]=e,"type"===t&&qt(i.config),i.onchange()}},i.getSubmission=function(t,i){void 0===t&&(t=""),void 0===i&&(i="value");var e=this.submission[this.getConfig("key")];return e?e[i]:t},i.setSubmission=function(t){null===t||!1===t||""===t||t===[]?delete this.submission[this.getConfig("key")]:(this.submission[this.getConfig("key")]||(this.submission[this.getConfig("key")]={value:""}),this.submission[this.getConfig("key")].value=t);var i=this.validationErrors[this.getConfig("key")];i&&delete i.errors,this.onchange()},i.whiteListConfigProperties=function(){return["title","description","required","key","fillGroupIds"]},i.configureView=function(){var t=this,i=[];Object.keys(this.validationErrors).forEach((function(e){t.validationErrors.hasOwnProperty(e)&&(Array.isArray(t.validationErrors[e])&&i.push.apply(i,t.validationErrors[e]),t.validationErrors[e].errors&&i.push.apply(i,t.validationErrors[e].errors))}));var e=this.whiteListConfigProperties(),o={short:r().translator.trans(xt+"type.short"),long:r().translator.trans(xt+"type.long"),number:r().translator.trans(xt+"type.number"),date:r().translator.trans(xt+"type.date"),checkbox:r().translator.trans(xt+"type.checkbox"),radio:r().translator.trans(xt+"type.radio"),select:r().translator.trans(xt+"type.select"),content:r().translator.trans(xt+"type.content")};return 0===this.depth&&(o.upload=r().translator.trans(xt+"type.upload"),o.items=r().translator.trans(xt+"type.items")),m(".FormulaireConfiguration",{key:this.getConfig("unique"),className:i.length?"in-error":""},[m(kt,{className:"FormulaireConfiguration-handle",disabled:this.disabled}),m(Ft,{errors:i}),m(".Form-group",[-1===e.indexOf("title")?null:m(".FormulaireInputWithLabel",{className:this.getConfig("title")?"FormulaireInputWithLabel--with-value":""},[m("input.FormControl",{type:"text",value:this.getConfig("title"),onchange:M()("value",this.setConfig("title")),disabled:this.disabled}),m("label",r().translator.trans(xt+"title"))]),wt().component({value:this.getConfig("type"),options:o,onchange:this.setConfig("type"),disabled:this.disabled})]),-1===e.indexOf("description")?null:m(".Form-group",m(".FormulaireInputWithLabel",{className:this.getConfig("description")?"FormulaireInputWithLabel--with-value":""},[m("textarea.FormControl",{value:this.getConfig("description"),onchange:M()("value",this.setConfig("description")),disabled:this.disabled}),m("label",r().translator.trans(xt+"description"))])),this.configure(),this.expertMode&&-1!==e.indexOf("key")?[m(".Form-group",m(".FormulaireInputWithLabel",{className:this.getConfig("key")?"FormulaireInputWithLabel--with-value":""},[m("input.FormControl",{type:"text",value:this.getConfig("key"),onchange:M()("value",this.setConfig("key")),disabled:this.disabled}),m("label",r().translator.trans(xt+"key"))])),m(".Form-group",[m("label",r().translator.trans(xt+"fill-permission")),ut.component({groupIds:this.getConfig("fillGroupIds",null),onchange:this.setConfig("fillGroupIds")})])]:null,m(".Form-group",[-1===e.indexOf("required")?null:bt().component({state:this.getConfig("required",!1),onchange:this.setConfig("required"),disabled:this.disabled},r().translator.trans(xt+"required"))," ",_().component({onclick:this.onduplicate.bind(this),className:"Button Button--icon",icon:"fas fa-clone",disabled:this.disabled,title:r().translator.trans(xt+"duplicate")})," ",_().component({onclick:this.ondelete.bind(this),className:"Button Button--icon",icon:"fas fa-trash",disabled:this.disabled,title:r().translator.trans(xt+"delete")})])])},i.choiceView=function(t,i,e){var o=this;void 0===e&&(e=!1);var n=this.getConfig("options",[]),a=this.getSubmission();Array.isArray(a)||(a=[]);var s,l=n.map((function(t){return t.key})),u=a.find((function(t){return-1===l.indexOf(t)})),d=void 0!==u;return m(".FormulaireChoice-OptionGroup",{className:e?"FormulaireChoice--radio":"FormulaireChoice--checkbox"},[n.map((function(r){var n=-1!==a.indexOf(r.key);return m(".FormulaireChoice-Option",t(n,(function(){n?o.setSubmission(a.filter((function(t){return t!==r.key}))):e?o.setSubmission([r.key]):o.setSubmission([r.key].concat(a))}),o.isFillDisabled()||i,r.key,[" ",r.title]))})),!this.getConfig("other")||i&&!d?null:(s=function(t){var i=a.filter((function(t){return-1!==l.indexOf(t)}));o.setSubmission([].concat(i,[t]))},m(".FormulaireChoice-Option.FormulaireChoice--other",[t(d,(function(){var t=a.filter((function(t){return-1!==l.indexOf(t)}));if(d)o.setSubmission(t);else{e?o.setSubmission([""]):o.setSubmission([].concat(t,[""]));var i=document.getElementById(o.uniqueFieldId()+"_other");i&&i.focus()}}),o.isFillDisabled()||i,"___other",[" ",r().translator.trans("kilowhat-formulaire.forum.choice.other-label")," "]),i?m("span",u):m("input.FormControl",{type:"text",id:o.uniqueFieldId()+"_other",placeholder:r().translator.trans("kilowhat-formulaire.forum.choice.other-placeholder"),value:u,onchange:M()("value",s),onclick:function(){d||s("")}})]))])},i.fillView=function(){var t=this.getConfig("title"),i=this.getConfig("description"),e=this.validationErrorsForThisField();return m(_t,{validationErrors:e,label:m("label",{for:this.uniqueFieldId()},[t||m("em",r().translator.trans(xt+"missing-title")),this.getConfig("required",!1)?m("span.FormulaireRequired"," *"):null]),description:i},this.fill())},i.display=function(){var t=this.getSubmission(),i=!!t;return Array.isArray(t)&&(i=t.length>0),m("p",i?t:m("em",r().translator.trans(xt+"no-answer")))},i.displayView=function(){var t=this.getConfig("title");return m("dl.Formulaire-field-display",[m("dt",[t||m("em",r().translator.trans(xt+"missing-title"))]),m("dd",this.display())])},i.optionsRule=function(){var t=this,i=this.getConfig("options",[]);Array.isArray(i)||(console.warn("Invalid options",i),i=[]);var e=!i.length||""!==i[i.length-1].title;return m(".Form-group",m("table.FormulaireItemsTable",[this.expertMode?m("thead",[m("th"),m("th",r().translator.trans("kilowhat-formulaire.forum.options-editor.columns.title")),m("th",r().translator.trans("kilowhat-formulaire.forum.options-editor.columns.key")),m("th")]):null,m(gt,{onsort:function(e,r){i.splice(r,0,i.splice(e,1)[0]),t.setConfig("options")(i)},containerTag:"tbody",placeholderTag:"tr"},i.map((function(e,o){return m("tr",{key:"item"+o},[m(kt,{elementTag:"td",className:"FormulaireItemsHandle"}),m("td",m("input.FormControl",{type:"text",value:e.title,onchange:M()("value",(function(r){e.title=r,t.setConfig("options")(i)}))})),t.expertMode?m("td",m("input.FormControl",{type:"text",value:e.key,onchange:M()("value",(function(r){e.key=r,t.setConfig("options")(i)}))})):null,m("td",_().component({onclick:function(){i.splice(o,1),t.setConfig("options")(i)},className:"Button Button--icon",icon:"fas fa-trash",disabled:t.isFillDisabled(),title:r().translator.trans("kilowhat-formulaire.forum.options-editor.remove")}))])}))),e?m("tbody",m("tr",[m("td"),m("td",m("input.FormControl",{type:"text",value:"",onchange:M()("value",(function(e){i.push({title:e}),t.setConfig("options")(i)})),placeholder:r().translator.trans("kilowhat-formulaire.forum.options-editor.new-placeholder")})),m("td")])):null]))},i.otherRule=function(){return m(".Form-group",bt().component({state:this.getConfig("other",!1),onchange:this.setConfig("other"),disabled:this.disabled},r().translator.trans("kilowhat-formulaire.forum.template-editor.other")))},i.minMaxRules=function(t){var i=this;return void 0===t&&(t="number"),m(".Form-group",[m(".FormulaireInputWithLabel",{className:this.getConfig("min")?"FormulaireInputWithLabel--with-value":""},[m("input.FormControl",{type:t,step:"number"===t?1:void 0,min:"number"===t?0:void 0,value:this.getConfig("min"),onchange:M()("value",(function(e){"number"===t&&e&&(e=parseInt(e)),i.setConfig("min")(e)})),disabled:this.disabled}),m("label",r().translator.trans(xt+"min"))]),m(".FormulaireInputWithLabel",{className:this.getConfig("max")?"FormulaireInputWithLabel--with-value":""},[m("input.FormControl",{type:t,step:"number"===t?1:void 0,min:"number"===t?0:void 0,value:this.getConfig("max"),onchange:M()("value",(function(e){"number"===t&&e&&(e=parseInt(e)),i.setConfig("max")(e)})),disabled:this.disabled}),m("label",r().translator.trans(xt+"max"))])])},i.isFillDisabled=function(){return this.disabled||this.getConfig("cannotFill")},i.validationErrorsForThisField=function(){var t=this.validationErrors[this.getConfig("key")];return null==t?void 0:t.errors},t}(),Ct=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["options","other","min","max"])},e.configure=function(){return[this.optionsRule(),this.otherRule(),this.minMaxRules()]},e.fill=function(t){return void 0===t&&(t=!1),this.choiceView((function(t,i,e,o,n){var a=r().forum.attribute("formulaireCheckboxStyle"),s=a&&"fa"===a.substr(0,2);return"switch"===a?bt().component({state:t,onchange:i,disabled:e},n):m("label",{className:s?"FormulaireFAControl":void 0},[m("input",{type:"checkbox",checked:t,onchange:i,disabled:e}),s?T()("fa"+a.substr(2,1)+" fa-"+(t?"check-":"")+a.substr(4)):null,n])}),t)},e.display=function(){return this.fill(!0)},i}(Et),St=function(){function t(){this.updateInterval=0}var i=t.prototype;return i.oncreate=function(t){var i;this.updateInterval=setInterval((function(){var e=t.dom.querySelector("textarea").value;if(i!==e)if(i=e)s9e.TextFormatter.preview(i,t.dom.querySelector(".js-preview"));else{var o=document.createElement("P");o.className="FormulaireRichPlaceholder",o.innerText=Q()(r().translator.trans("kilowhat-formulaire.forum.rich-text.preview-placeholder"));var n=t.dom.querySelector(".js-preview");n.innerHTML="",n.appendChild(o)}}),50)},i.onremove=function(){clearInterval(this.updateInterval)},i.view=function(t){return m(".FormulaireRich",[m(".FormulaireRichPreview.js-preview",{onclick:function(i){i.preventDefault(),t.dom.querySelector("textarea").focus()}}),m("textarea.FormControl",t.attrs)])},t}(),It=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return["content"]},e.configure=function(){return m(".Form-group",m(St,{value:this.getConfig("content"),onchange:M()("value",this.setConfig("content")),disabled:this.disabled}))},e.fill=function(){return null},e.fillView=function(){return m("div",m.trust(this.getConfig("contentHtml")))},e.displayView=function(){return null},i}(Et),At=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["min","max"])},e.configure=function(){return this.minMaxRules("date")},e.fill=function(){var t={type:"date",id:this.uniqueFieldId(),className:this.validationErrorsForThisField()?"in-error":"",value:this.getSubmission(),onchange:M()("value",this.setSubmission.bind(this)),disabled:this.isFillDisabled()};return this.getConfig("min")&&(t.min=this.getConfig("min")),this.getConfig("max")&&(t.max=this.getConfig("max")),m("input.FormControl",t)},i}(Et),Nt="kilowhat-formulaire.forum.items-editor.",Pt=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["fields","min","max"])},e.configure=function(){var t=this,i=this.validationErrors[this.getConfig("key")]||{},e=new Ut({configs:this.getConfig("fields"),onchange:function(){t.onchange()},disabled:this.disabled,validationErrors:i,depth:this.depth+1,expertMode:this.expertMode});return m(".FormulaireConfigurationSubFields",[m(Ft,{errors:i}),this.minMaxRules(),e.configureView()])},e.fill=function(t){var i=this;void 0===t&&(t=!1);var e=this.getConfig("fields");this.submission[this.getConfig("key")]||(this.submission[this.getConfig("key")]={value:[]});var o=this.getSubmission();if(0===o.length)for(var n=0;n<this.getConfig("min",0);n++)o.push({});var a=this.validationErrors[this.getConfig("key")]||{};return m("table",{className:t?"FormulaireDataTable":"FormulaireItemsTable"},[m("thead",m("tr",[t?null:m("th"),e.map((function(i){var e=new Ht[i.type]({config:i}),o=e.getConfig("title"),n=e.getConfig("description");return m("th",[m("label",[o||r().translator.trans("kilowhat-formulaire.forum.template-editor.missing-title"),!t&&e.getConfig("required",!1)?m("span.FormulaireRequired"," *"):null]),!t&&n?m("p",n):null])})),t?null:m("th")])),m(gt,{onsort:function(t,e){o.splice(e,0,o.splice(t,1)[0]),i.onchange()},disabled:this.isFillDisabled(),containerTag:"tbody",placeholderTag:"tr"},o.map((function(n,s){var l=a[s]||{};return m("tr",{key:"item"+s},[t?null:m(kt,{elementTag:"td",className:"FormulaireItemsHandle",disabled:i.isFillDisabled()}),e.map((function(e){var r=new Ht[e.type]({config:e,submission:n,uploader:i.uploader,onchange:function(){i.onchange()},disabled:i.isFillDisabled(),validationErrors:l,depth:i.depth+1});return m("td",[t?r.display():r.fill(),m(Ft,{errors:l[e.key||""]})])})),t?null:m("td",_().component({onclick:function(){o.splice(s,1),i.onchange()},className:"Button Button--icon",icon:"fas fa-trash",disabled:i.isFillDisabled(),title:r().translator.trans(Nt+"remove")}))])}))),t?null:m("tbody",m("tr",[m("td"),m("td",{colspan:e.length},_().component({onclick:function(){o.push({}),i.onchange()},className:"Button Button--block",disabled:this.isFillDisabled()||this.getConfig("max",0)&&o.length>=this.getConfig("max","")},r().translator.trans(Nt+"add"))),m("td")]))])},e.display=function(){return this.fill(!0)},i}(Et),Tt=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["min","max","rich"])},e.configure=function(){return[this.minMaxRules(),m(".Form-group",[bt().component({state:this.getConfig("rich",!1),onchange:this.setConfig("rich"),disabled:this.disabled},r().translator.trans("kilowhat-formulaire.forum.template-editor.rich"))])]},e.fill=function(){var t={id:this.uniqueFieldId(),className:this.validationErrorsForThisField()?"in-error":"",value:this.getSubmission(),oninput:M()("value",this.setSubmission.bind(this)),disabled:this.isFillDisabled()};return[this.getConfig("rich")?m(St,t):m("textarea.FormControl",t),this.getConfig("max")?m(".FormulaireTextLength",[m("span.FormulaireTextLengthValue",{className:this.getSubmission().length>this.getConfig("max")?"FormulaireTextLengthValueTooLong":""},this.getSubmission().length),"/"+this.getConfig("max")]):null]},e.display=function(){if(this.getConfig("rich")){var i=this.getSubmission("","html");if(i)return m("div",m.trust(i))}return t.prototype.display.call(this)},i}(Et),Ot=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["integer","min","max"])},e.configure=function(){return[m(".Form-group",bt().component({state:this.getConfig("integer",!1),onchange:this.setConfig("integer"),disabled:this.disabled},r().translator.trans("kilowhat-formulaire.forum.template-editor.integer"))),this.minMaxRules()]},e.fill=function(){var t={type:"number",step:this.getConfig("integer")?1:"any",id:this.uniqueFieldId(),className:this.validationErrorsForThisField()?"in-error":"",value:this.getSubmission(),onchange:M()("value",this.setSubmission.bind(this)),disabled:this.isFillDisabled()};return this.getConfig("min")&&(t.min=this.getConfig("min")),this.getConfig("max")&&(t.max=this.getConfig("max")),m("input.FormControl",t)},i}(Et),Dt=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["options","other"])},e.configure=function(){return[this.optionsRule(),this.otherRule()]},e.fill=function(t){var i=this;return void 0===t&&(t=!1),this.choiceView((function(e,o,n,a,s){var l=r().forum.attribute("formulaireRadioStyle"),u=l&&"fa"===l.substr(0,2);return m("label",{className:u?"FormulaireFAControl":void 0},[m("input",{type:"radio",name:t?void 0:i.uniqueFieldId(),value:t?void 0:a,checked:e,onchange:o,disabled:n}),u?T()("fa"+l.substr(2,1)+" fa-"+(e?"dot-":"")+l.substr(4)):null,s])}),t,!0)},e.display=function(){return this.fill(!0)},i}(Et),Lt=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["options"])},e.configure=function(){return[this.optionsRule()]},e.fill=function(){var t=this,i=this.getConfig("options",[]),e=this.getSubmission(),o=Array.isArray(e)&&e.length?e[0]:"";return m(".Select",[m("select.Select-input.FormControl",{id:this.uniqueFieldId(),onchange:M()("value",(function(i){i?t.setSubmission([i]):t.setSubmission([])})),value:o,disabled:this.isFillDisabled()},[m("option",{value:"",hidden:!!this.getConfig("required")},r().translator.trans("kilowhat-formulaire.forum.select.choose")),i.map((function(t){return m("option",{value:t.key},t.title)}))]),T()("fas fa-sort",{className:"Select-caret"})])},e.display=function(){var i=this.getConfig("options",[]),e=this.getSubmission();if(Array.isArray(e)&&e.length){var r=i.find((function(t){return t.key===e[0]}));if(r)return m("p",r.title)}return t.prototype.display.call(this)},i}(Et),Mt=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["email","regex"])},e.configure=function(){return[m(".Form-group",bt().component({state:this.getConfig("email",!1),onchange:this.setConfig("email"),disabled:this.disabled},r().translator.trans("kilowhat-formulaire.forum.template-editor.email"))),m(".Form-group",m(".FormulaireInputWithLabel",{className:this.getConfig("regex")?"FormulaireInputWithLabel--with-value":""},[m("input.FormControl",{type:"text",value:this.getConfig("regex"),onchange:M()("value",this.setConfig("regex")),disabled:this.disabled}),m("label",r().translator.trans("kilowhat-formulaire.forum.template-editor.regex"))]))]},e.fill=function(){return m("input.FormControl",{type:this.getConfig("email",!1)?"email":"text",id:this.uniqueFieldId(),className:this.validationErrorsForThisField()?"in-error":"",value:this.getSubmission(),onchange:M()("value",this.setSubmission.bind(this)),disabled:this.isFillDisabled()})},i}(Et),Bt="kilowhat-formulaire.forum.upload-editor.",Rt=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.whiteListConfigProperties=function(){return t.prototype.whiteListConfigProperties.call(this).concat(["mime","min","max"])},e.configure=function(){return[m(".Form-group",m(".FormulaireInputWithLabel",{className:this.getConfig("mime")?"FormulaireInputWithLabel--with-value":""},[m("input.FormControl",{type:"text",value:this.getConfig("mime"),onchange:M()("value",this.setConfig("mime")),disabled:this.disabled}),m("label",r().translator.trans("kilowhat-formulaire.forum.template-editor.mime"))])),this.minMaxRules()]},e.fill=function(){var t,i=this,e=1!==this.getConfig("max"),o=this.getSubmission([]);return[m("ul",o.map((function(t){var e=r().store.getById("formulaire-files",t);return m("li",[e?m("a",{href:e.url(),download:e.filename()},[e.filename(),e.humanSize()?[" (",e.humanSize(),")"]:null]):t," ",o.length>i.getConfig("min")?_().component({onclick:function(){i.setSubmission(i.getSubmission([]).filter((function(i){return i!==t})))},className:"Button Button--icon",icon:"fas fa-trash",disabled:i.isFillDisabled(),title:r().translator.trans(Bt+"remove")}):null])}))),null!=(t=this.uploader)&&t.uploading?r().translator.trans(Bt+"uploading"):null,m("input",{type:"file",id:this.uniqueFieldId(),onchange:function(t){var r;null==(r=i.uploader)||r.upload(t.target.files,i.getConfig("key")).then((function(t){var r=JSON.parse(JSON.stringify(i.getSubmission([])));e?t.forEach((function(t){r.push(t.id())})):r=t.map((function(t){return t.id()})),i.setSubmission(r),m.redraw()}))},disabled:this.isFillDisabled(),accept:this.getConfig("mime"),multiple:e})]},e.display=function(){var t=this.getSubmission([]);return[m("ul",t.map((function(t){var i=r().store.getById("formulaire-files",t);return m("li",[i?m("a",{href:i.url(),download:i.filename()},[i.filename(),i.humanSize()?[" (",i.humanSize(),")"]:null]):t])})))]},i}(Et);const Ht={checkbox:Ct,content:It,date:At,items:Pt,long:Tt,number:Ot,radio:Dt,select:Lt,short:Mt,upload:Rt};var Vt=0;function qt(t,i){void 0===i&&(i=!1),t.unique&&!i||(t.unique=++Vt+""),i&&delete t.key;var e=new Ht[t.type]({}),r=["unique","type","cannotFill","contentHtml"].concat(e.whiteListConfigProperties());Object.keys(t).forEach((function(i){-1===r.indexOf(i)&&delete t[i]})),"items"===t.type&&(Array.isArray(t.fields)||(t.fields=[]),0===t.fields.length&&t.fields.push({type:"short"})),"upload"===t.type&&(t.mime||(t.mime="image/*"))}var Ut=function(){function t(t){var i=t.configs,e=void 0===i?[]:i,r=t.submission,o=void 0===r?{}:r,n=t.uploader,a=void 0===n?null:n,s=t.onchange,l=void 0===s?function(){}:s,u=t.disabled,m=void 0!==u&&u,d=t.validationErrors,c=void 0===d?{}:d,f=t.depth,h=void 0===f?0:f,p=t.expertMode,g=void 0!==p&&p;this.configs=void 0,this.submission=void 0,this.uploader=void 0,this.onchange=void 0,this.disabled=void 0,this.validationErrors=void 0,this.depth=void 0,this.expertMode=void 0,this.configs=e,this.submission=o,this.uploader=a,this.onchange=l,this.disabled=m,this.validationErrors=c,this.depth=h,this.expertMode=g}var i=t.prototype;return i.configureView=function(){var t=this;return[m(gt,{onsort:function(i,e){t.configs.splice(e,0,t.configs.splice(i,1)[0]),t.onchange()},disabled:this.disabled},this.configs.map((function(i,e){return new Ht[i.type]({config:i,uploader:t.uploader,onchange:function(){t.onchange()},onduplicate:function(){t.configs.splice(e+1,0,JSON.parse(JSON.stringify(i))),qt(t.configs[e+1],!0),t.onchange()},ondelete:function(){t.configs.splice(e,1),t.onchange()},disabled:t.disabled,validationErrors:t.validationErrors,depth:t.depth,expertMode:t.expertMode}).configureView()}))),_().component({className:"Button Button--block",onclick:function(){t.configs.push({type:"short"}),t.onchange()},disabled:this.disabled},r().translator.trans("kilowhat-formulaire.forum.template-editor.add-field"))]},i.listView=function(t){var i=this;return void 0===t&&(t=!1),[this.configs.map((function(e){var r=new Ht[e.type]({config:e,submission:i.submission,uploader:i.uploader,onchange:function(){i.onchange()},disabled:i.disabled,validationErrors:i.validationErrors,depth:i.depth});return t?r.displayView():r.fillView()}))]},t}(),jt=function(){function t(t){this.value=void 0,this.history=[],this.historyIndex=0,this.value=JSON.parse(JSON.stringify(t)),this.save()}var i=t.prototype;return i.save=function(){this.historyIndex>0&&this.history.splice(0,this.historyIndex),this.history.unshift(JSON.parse(JSON.stringify(this.value))),this.historyIndex=0},i.canUndo=function(){return this.history.length>1&&this.historyIndex<this.history.length-1},i.canRedo=function(){return this.historyIndex>0},i.undo=function(){this.canUndo()&&(this.value=this.history[++this.historyIndex])},i.redo=function(){this.canRedo()&&(this.value=this.history[--this.historyIndex])},i.clear=function(){this.history.splice(1),this.historyIndex=0},t}();const Gt=flarum.core.compat["common/utils/RequestError"];var zt=t.n(Gt),Wt="/data/attributes/".length;function Jt(t){var i,e,r={};return null==(i=t.response)||null==(e=i.errors)||e.forEach((function(t){var i,e,o=r;(null==t||null==(i=t.source)||null==(e=i.pointer)?void 0:e.substr(Wt).split("/")).forEach((function(t){if(o[t])o=o[t];else{var i={};o[t]=i,o=i}})),o.errors=Array.isArray(t.detail)?t.detail:[t.detail]})),r}var Kt=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).errorPage=null,i.dirty=!1,i.loading=!1,i.savedAt=null,i.validationErrors={},i}a(i,t);var e=i.prototype;return e.pageLoadErrorHandler=function(t){switch(t.status){case 401:case 403:this.errorPage="denied";break;case 404:case 410:this.errorPage="notfound";break;default:throw t}m.redraw()},e.onerror=function(t){this.loading=!1;var i=!1;if(422===t.status&&t.response.errors?(i=!0,this.validationErrors=Jt(t)):this.validationErrors={},m.redraw(),!i){if(!(t instanceof zt()))throw t;if(r().forum.attribute("debug")&&t.xhr){var e=t.options,o=e.method,n=e.url,a=t.xhr.status,s=void 0===a?"":a;console.group(o+" "+n+" "+s),console.error(t),console.groupEnd()}t.alert&&r().alerts.show(t.alert,t.alert.content)}},i}(w()),Xt=function(){function t(){}return t.prototype.view=function(t){var i=t.attrs.error;return m("div",[m("h3",r().translator.trans("kilowhat-formulaire.forum.error-page."+i+"-title")),m("p",r().translator.trans("kilowhat-formulaire.forum.error-page."+i+"-description"))])},t}(),Yt=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).form=void 0,i}a(i,t);var e=i.prototype;return e.oninit=function(i){var e=this;t.prototype.oninit.call(this,i);var o=m.route.param("id"),n=r().preloadedApiDocument();if(n)this.show(n);else{var a=r().store.getById("formulaire-forms",o);a?this.show(a):r().store.find("formulaire/forms",o,{},{errorHandler:this.pageLoadErrorHandler.bind(this)}).then((function(t){e.show(t),m.redraw()}))}},e.onremove=function(i){t.prototype.onremove.call(this,i),delete document.body.dataset.formulaireFormId},e.show=function(t){this.form=t,document.body.dataset.formulaireFormId=t.id()},e.view=function(){return this.errorPage?m(W,m(Xt,{error:this.errorPage})):this.form?this.content(this.form):m(".container",C().component({className:"LoadingIndicator--block"}))},i}(Kt);const Qt=flarum.core.compat["common/helpers/humanTime"];var Zt=t.n(Qt),$t="kilowhat-formulaire.forum.save-controls.",ti=function(){function t(){this.previouslyPromptedForUser=!1,this.inCooldownPeriod=!1,this.updateOverlayWidth=void 0}var i=t.prototype;return i.view=function(t){var i=this,e=t.attrs,o=e.dirty,n=e.loading,a=e.savedAt,s=e.inError,l=e.onsave,u=e.history,d=e.floating,c=!!o;u&&(c=c||u.canUndo()||u.canRedo()),this.previouslyPromptedForUser&&!c&&(this.inCooldownPeriod=!0,setTimeout((function(){i.inCooldownPeriod=!1,m.redraw()}),1e3)),this.previouslyPromptedForUser=c,c=c||this.inCooldownPeriod;var f=null;return s?f=m("span.in-error",[T()("fas fa-exclamation-triangle")," ",r().translator.trans($t+"validation-errors")]):o?f=r().translator.trans($t+"unsaved-changes"):a&&(f=m("span.success",[T()("fas fa-check")," ",r().translator.trans($t+"saved-at",{ago:Zt()(a)})])),m(".FormulaireSaveWrapper",m(".FormulaireSave",{className:d&&c?"floating":""},[m(".FormulaireSave-stretch",f),u?[_().component({onclick:function(){u.undo()},disabled:!u.canUndo()||n,className:"Button",icon:"fas fa-undo"},r().translator.trans($t+"undo")),_().component({onclick:function(){u.redo()},disabled:!u.canRedo()||n,className:"Button",icon:"fas fa-redo"},r().translator.trans($t+"redo"))]:null,_().component({onclick:l,disabled:!o||n,className:"Button Button--primary FormulairePrimaryButton",icon:"fas fa-save",loading:n},r().translator.trans($t+"save"))]))},i.oncreate=function(t){this.updateOverlayWidth=function(){var i=t.dom.querySelector(".FormulaireSave"),e=t.dom.getBoundingClientRect();i&&e.width>0&&(i.style.width=e.width+"px")},t.dom.closest(".Modal")?setTimeout(this.updateOverlayWidth,300):this.updateOverlayWidth(),window.addEventListener("resize",this.updateOverlayWidth)},i.onremove=function(){window.removeEventListener("resize",this.updateOverlayWidth)},t}(),ii=function(){function t(){}return t.prototype.view=function(t){var i=t.attrs.form,e=i.badges().toArray();return m("h2.App-titleControl",[i.title()," ",e.length?m("ul.FormulaireDataTable-badges.badges",N()(e)):null])},t}(),ei=function(){function t(t){this.form=void 0,this.uploading=!1,this.form=t}return t.prototype.upload=function(t,i){var e=this;if(!t)return Promise.reject();for(var o=new FormData,n=0;n<t.length;n++)o.append(i+"[]",t[n]);return this.uploading=!0,m.redraw(),new Promise((function(t,i){r().request({method:"POST",url:r().forum.attribute("apiUrl")+e.form.apiEndpoint()+"/upload",serialize:function(t){return t},body:o}).then((function(i){e.uploading=!1,m.redraw(),t(r().store.pushPayload(i))})).catch((function(t){e.uploading=!1,m.redraw(),i(t)}))}))},t}();function ri(t){return-1!==(r().forum.attribute("formulaireHorizontalLayout")||[]).indexOf(t)}var oi="kilowhat-formulaire.forum.submission.",ni=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).history=void 0,i.uploader=void 0,i.submission=null,i}a(i,t);var e=i.prototype;return e.oninit=function(i){t.prototype.oninit.call(this,i),this.bodyClass="FormulaireFormShowPage"},e.show=function(i){t.prototype.show.call(this,i),this.history=new jt({}),this.uploader=new ei(i)},e.content=function(t){var i=this;if(!t.attribute("canSubmit"))return m(W,{showSideNav:r().forum.attribute("formulaireShowSideNavOnSubmission"),narrow:!0,noTheme:!0},[m(ii,{form:t}),m("p",r().translator.trans(oi+(t.attribute("isFull")?"form-full":"form-closed")))]);if(this.submission){var e=t.confirmationMessageHtml();return m(W,{showSideNav:r().forum.attribute("formulaireShowSideNavOnSubmission"),narrow:!0,noTheme:!0},[m(ii,{form:t}),e?m("div",m.trust(e)):m("p",r().translator.trans(oi+"submitted-successfully")),this.submission.attribute("canEdit")?x().component({className:"Button",href:V(this.submission)},r().translator.trans(oi+"edit-submission")):null,x().component({className:"Button",href:B(t)},r().translator.trans(oi+"submit-other"))])}var o=new Ut({configs:t.template(),submission:this.history.value,uploader:this.uploader,onchange:function(){i.history.save(),i.dirty=!0},disabled:this.loading||this.uploader.uploading,validationErrors:this.validationErrors});return m(W,{showSideNav:r().forum.attribute("formulaireShowSideNavOnSubmission"),narrow:!0,noTheme:!0},[m(ii,{form:t}),m("div",{className:ri("StandaloneEdit")?"Formulaire-horizontal-layout":""},o.listView()),m(ti,{dirty:this.dirty,loading:this.loading,savedAt:this.savedAt,inError:Object.keys(this.validationErrors).length>0,history:r().forum.attribute("formulaireShowHistoryControls")?this.history:null,onsave:function(){i.loading=!0,r().request({method:"POST",url:r().forum.attribute("apiUrl")+t.apiEndpoint()+"/submissions",body:{data:{attributes:{data:i.history.value}}},errorHandler:i.onerror.bind(i)}).then((function(t){i.submission=r().store.pushPayload(t),i.loading=!1,i.dirty=!1,i.savedAt=new Date,i.validationErrors={},i.history.clear(),m.redraw()})).catch((function(t){throw i.loading=!1,m.redraw(),t}))}})])},i}(Yt),ai="kilowhat-formulaire.forum.auto-discussion-options-modal.",si=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).options=void 0,i}a(i,t);var e=i.prototype;return e.oninit=function(i){t.prototype.oninit.call(this,i),this.options=JSON.parse(JSON.stringify(this.attrs.options))},e.className=function(){return"FormulaireModal FormulaireTheme"},e.title=function(){return r().translator.trans(ai+"title")},e.content=function(){var t=this;return m(".Modal-body",[m(".Form-group",m("p",r().translator.trans(ai+"introduction",{" title ":m("code","{ title }")," content ":m("code","{ content }")}))),m(_t,{label:m("label",r().translator.trans(ai+"field.title"))},m("input.FormControl",{type:"text",value:this.options.title||"",oninput:M()("value",(function(i){t.options.title=i}))})),m(_t,{label:m("label",r().translator.trans(ai+"field.tags")),description:r().translator.trans(ai+"field.tags-help")},m("input.FormControl",{type:"text",value:this.options.tags||"",oninput:M()("value",(function(i){t.options.tags=i}))})),m(_t,{label:m("label",r().translator.trans(ai+"field.content"))},m(St,{value:this.options.content||"",onchange:M()("value",(function(i){t.options.content=i}))})),m(".Form-group",_().component({type:"submit",className:"Button Button--primary"},r().translator.trans(ai+"submit")))])},e.onsubmit=function(t){t.preventDefault(),this.attrs.onchange(this.options)},i}(D()),li="kilowhat-formulaire.forum.confirmation-email-options-modal.",ui=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).titleValue=void 0,i.message=void 0,i}a(i,t);var e=i.prototype;return e.oninit=function(i){t.prototype.oninit.call(this,i),this.titleValue=this.attrs.title,this.message=this.attrs.message},e.className=function(){return"FormulaireModal FormulaireTheme"},e.title=function(){return r().translator.trans(li+"title")},e.content=function(){var t=this;return m(".Modal-body",[m(_t,{label:m("label",r().translator.trans(li+"field.title"))},m("input.FormControl",{type:"text",value:this.titleValue,oninput:M()("value",(function(i){t.titleValue=i}))})),m(_t,{label:m("label",r().translator.trans(li+"field.message"))},m(St,{value:this.message,onchange:M()("value",(function(i){t.message=i}))})),m(".Form-group",_().component({type:"submit",className:"Button Button--primary"},r().translator.trans(li+"submit")))])},e.onsubmit=function(t){t.preventDefault(),this.attrs.onchange(this.titleValue,this.message)},i}(D()),mi=function(){function t(){}return t.prototype.view=function(t){if(t.attrs.editable){var i=m("input.FormulaireDiscreetInput",{value:t.attrs.value,onchange:M()("value",(function(i){t.attrs.onchange(i)})),placeholder:t.attrs.placeholder,title:t.attrs.title});return t.attrs.validationErrors?m(_t,{validationErrors:t.attrs.validationErrors},i):i}return m("span.FormulaireDiscreetInput",{title:t.attrs.title},t.attrs.value||t.attrs.placeholder)},t}(),di="kilowhat-formulaire.forum.form-edit-header.",ci=[{key:"template",icon:"fas fa-poll-h"},{key:"placement",icon:"fas fa-puzzle-piece"},{key:"access",icon:"fas fa-user-shield"},{key:"notifications",icon:"fas fa-envelope"}],fi=function(){function t(){this.restoring=!1,this.deleting=!1}var i=t.prototype;return i.view=function(t){var i,e=this,o=t.attrs,n=o.form,a=o.editable,s=o.validationErrors,l=void 0===s?{}:s,u=this.controls(n,t).toArray();switch(n.type()){case"standalone":i=r().route("formulaireFormIndex");break;case"discussion":i=r().route("formulaireFormIndexDiscussion");break;case"user":i=r().route("formulaireFormIndexUser")}return m(".FormulaireHeader",[m(X(),{className:"FormulaireHeader-controls App-primaryControl",menuClassName:"Dropdown-menu--right",buttonClassName:"Button Button--icon Button--flat",label:r().translator.trans(di+"controls"),icon:"fas fa-ellipsis-v"},u),m(".FormulaireHeader-back",[x().component({icon:"fas fa-arrow-left",href:i,className:"Button Button--flat"},r().translator.trans(di+"category."+n.type()))]),m("h1",m(mi,{title:r().translator.trans(di+"fields.private-title"),editable:a,value:n.private_title(),placeholder:r().translator.trans(di+"fields.private-title"),onchange:function(i){t.attrs.updateAttribute("private_title",i)},validationErrors:l.private_title})),"discussion"!==n.type()||n.isAutoLink()?m(".FormulaireHeader-url",[m("a",{href:"user"===n.type()?r().route("formulaireProfile",{username:r().session.user.username(),form:n.seoId()}):r().route("formulaireFormShow",{id:n.seoId()}),target:"_blank"},r().forum.attribute("baseUrl")+("user"===n.type()?r().route("formulaireProfile",{username:r().session.user.username(),form:""}):r().route("formulaireFormShow",{id:""})))," ",m(mi,{title:r().translator.trans(di+"fields.slug"),editable:a,value:n.slug(),placeholder:n.id(),onchange:function(i){t.attrs.updateAttribute("slug",i)},validationErrors:l.slug})]):null,m(".FormulaireTabs",[ci.filter((function(t){return"notifications"!==t.key||"standalone"===n.type()||n.isAutoLink()})).map((function(i){return m(_(),{className:t.attrs.tab===i.key?"active":"",icon:i.icon,onclick:function(){t.attrs.changeTab(i.key)}},[r().translator.trans(di+"tabs."+i.key),"access"===i.key?e.accessStatus(n):null])})),m(x(),{className:t.attrs.isSubmissionPage?"active":"",icon:"fas fa-list",href:H(n)},[r().translator.trans(di+"tabs.submissions")," ",m("span.badge",$(n))])])])},i.controls=function(t,i){var e=this,o=new(h());o.add("export",_().component({icon:"fas fa-file-export",onclick:function(){i.attrs.changeTab("export")}},r().translator.trans(di+"template-export")));var n="true"===localStorage.getItem("formulaireExpertMode");return o.add("expert",_().component({icon:"fas fa-toolbox",onclick:function(){n?localStorage.removeItem("formulaireExpertMode"):localStorage.setItem("formulaireExpertMode","true")}},r().translator.trans(di+(n?"disable":"enable")+"-expert-mode"))),t.isHidden()&&t.attribute("canRestore")&&o.add("hide",_().component({icon:"fas fa-reply",loading:this.restoring,onclick:function(){e.restoring=!0,t.save({isHidden:!1}).then((function(){e.restoring=!1,m.redraw()})).catch((function(t){throw e.restoring=!1,m.redraw(),t}))}},r().translator.trans(di+"restore"))),!t.isHidden()&&t.attribute("canHide")&&o.add("hide",_().component({icon:"far fa-trash-alt",loading:this.deleting,onclick:function(){e.deleting=!0,t.save({isHidden:!0}).then((function(){e.deleting=!1,m.redraw()})).catch((function(t){throw e.deleting=!1,m.redraw(),t}))}},r().translator.trans(di+"hide"))),t.isHidden()&&t.attribute("canDelete")&&o.add("delete",_().component({icon:"fas fa-times",loading:this.deleting,onclick:function(){confirm(Q()(r().translator.trans(di+"delete-confirmation",{title:t.title()})))&&(e.deleting=!0,t.delete().then((function(){e.deleting=!1,m.redraw(),m.route.set(r().route("formulaireFormIndex"))})).catch((function(t){throw e.deleting=!1,m.redraw(),t})))}},r().translator.trans(di+"delete"))),o},i.accessStatus=function(t){var i=t.accept_submissions(),e=t.allow_modification(),o="closed";return"standalone"!==t.type()?o=i?"enabled":"disabled":i&&e?o="both":i?o="create":e&&(o="edit"),[" ",m("span.badge",r().translator.trans(di+"access-status."+o))]},t}(),hi="kilowhat-formulaire.forum.form-edit.",pi=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).tab="template",i.history=void 0,i.windowOnbeforeunload=void 0,i.tagsLoading=!1,i.tagsLoaded=!1,i}a(i,t);var e=i.prototype;return e.oninit=function(i){t.prototype.oninit.call(this,i),r().cache.formulaireFormEditTab&&(this.tab=r().cache.formulaireFormEditTab,delete r().cache.formulaireFormEditTab)},e.show=function(t){this.form=r().store.createRecord("formulaire-forms",t.copyData()),this.form.exists=!0,this.history=new jt(t.template()),this.loadTagsIfNecessary()},e.oncreate=function(i){var e=this;t.prototype.oncreate.call(this,i),this.windowOnbeforeunload=function(t){e.dirty&&(t.preventDefault(),t.returnValue=Q()(r().translator.trans(hi+"exiting-with-unsaved-data")))},window.addEventListener("beforeunload",this.windowOnbeforeunload)},e.onbeforeremove=function(){return this.dirty&&!confirm(Q()(r().translator.trans(hi+"exiting-with-unsaved-data")))?Promise.reject():(window.removeEventListener("beforeunload",this.windowOnbeforeunload),Promise.resolve())},e.onremove=function(){window.removeEventListener("beforeunload",this.windowOnbeforeunload)},e.content=function(t){var i=this;if(!t.attribute("canEdit"))return m(W,"Cannot edit");var e=this.warnings(t);return m(W,[m(fi,{form:t,tab:this.tab,changeTab:function(t){i.tab=t,i.loadTagsIfNecessary()},editable:!0,updateAttribute:this.updateAttribute.bind(this),validationErrors:this.validationErrors}),e.map((function(t){return m(".Alert.Alert--warning",t)})),m(".FormulaireEditFormTab",m("div",{key:this.tab},this[this.tab+"Tab"](t))),m(ti,{dirty:this.dirty,loading:this.loading,savedAt:this.savedAt,inError:Object.keys(this.validationErrors).length>0,history:this.history,onsave:function(){i.loading=!0,t.save({link_type:t.link_type(),link_id:t.link_id(),slug:t.slug(),title:t.title(),private_title:t.private_title(),template:i.history.value,accept_submissions:t.accept_submissions(),allow_modification:t.allow_modification(),max_submissions:t.max_submissions(),send_confirmation_to_participants:t.send_confirmation_to_participants(),notify_emails:t.notify_emails(),web_confirmation_message:t.web_confirmation_message(),email_confirmation_message:t.email_confirmation_message(),email_notification_message:t.email_notification_message(),email_confirmation_title:t.email_confirmation_title(),email_notification_title:t.email_notification_title(),automatic_discussion_options:t.automatic_discussion_options(),permission_see_own:t.permission_see_own(),permission_see_any:t.permission_see_any(),permission_edit_own:t.permission_edit_own(),permission_edit_any:t.permission_edit_any(),show_on_creation:t.show_on_creation()},{errorHandler:i.onerror.bind(i)}).then((function(){i.loading=!1,i.dirty=!1,i.savedAt=new Date,i.validationErrors={},i.history=new jt(t.template()),m.redraw()})).catch((function(t){throw i.loading=!1,m.redraw(),t}))},floating:!0})])},e.templateTab=function(t){var i=this,e="true"===localStorage.getItem("formulaireExpertMode"),o=new Ut({configs:this.history.value,onchange:function(){i.history.save(),i.dirty=!0},disabled:this.loading,validationErrors:this.validationErrors.template||{},expertMode:e});return[m(_t,{validationErrors:this.validationErrors.title,label:m("label",r().translator.trans(hi+"field.title"))},m("input.FormControl",{type:"text",value:t.title(),oninput:M()("value",(function(t){i.updateAttribute("title",t)})),disabled:this.loading})),m("h2",[r().translator.trans(hi+"section.template")," ",m("small",[m("a",{href:B(t),target:"_blank"},r().translator.trans(hi+(this.dirty?"save-for-preview":"preview")))," ",T()("fas fa-external-link-alt")])]),e?m(".Form-group",m(".Alert.Alert--warning",r().translator.trans(hi+"expert-mode-warning"))):null,o.configureView()]},e.placementTab=function(t){var i,e,o=this,n={};return"groups"===t.link_type()?(n.all=r().translator.trans(hi+"link-options.all-groups"),r().store.all("groups").forEach((function(t){t.id()!==ot().GUEST_ID&&t.id()!==ot().MEMBER_ID&&(n[t.id()]=t.namePlural())}))):"tags"===t.link_type()&&(n.all=r().translator.trans(hi+"link-options.all-tags"),"flarum-tags"in flarum.extensions&&r().store.all("tags").forEach((function(t){n[t.id()]=t.name()}))),[m(_t,{validationErrors:this.validationErrors.link_type||this.validationErrors.link_id,label:m("label",r().translator.trans(hi+"field.link"))},[wt().component({options:{standalone:r().translator.trans(hi+"link-options.standalone"),groups:r().translator.trans(hi+"link-options.groups"),tags:r().translator.trans(hi+"link-options.tags")},value:t.link_type()||"standalone",onchange:function(t){o.updateAttribute("link_type","standalone"===t?null:t),o.updateAttribute("link_id",null),o.loadTagsIfNecessary()},disabled:this.loading})," ",null!==t.link_type()?m.fragment({},m.fragment({key:JSON.stringify(Object.keys(n))},wt().component({options:n,value:t.link_id()||"all",onchange:function(t){o.updateAttribute("link_id","all"===t?null:t)},disabled:this.loading||this.tagsLoading}))):null,this.tagsLoading?C().component({display:"inline"}):null]),"standalone"!==t.type()?m(_t,{validationErrors:this.validationErrors.show_on_creation},[bt().component({state:t.show_on_creation(),onchange:this.updateAttribute.bind(this,"show_on_creation"),disabled:this.loading},r().translator.trans(hi+"field.show-on-creation."+t.type())),"discussion"!==t.type()||"clarkwinkelmann-composer-page"in flarum.extensions?null:m(".Alert",r().translator.trans(hi+"field.show-on-creation.discussionHelp",{a:m("a",{href:"https://github.com/clarkwinkelmann/flarum-ext-composer-page",target:"_blank",rel:"noopener"})}))]):null,"discussion"===t.type()?m(_t,{validationErrors:this.validationErrors.automatic_discussion_options},[bt().component({state:null==(i=t.automatic_discussion_options())?void 0:i.enabled,onchange:function(i){var e=t.automatic_discussion_options()||{};e.enabled=i,o.updateAttribute("automatic_discussion_options",e)},disabled:this.loading},r().translator.trans(hi+"field.automatic-discussion")),_().component({className:"Button",disabled:!(null!=(e=t.automatic_discussion_options())&&e.enabled),onclick:function(){r().modal.show(si,{options:t.automatic_discussion_options()||{},onchange:function(t){o.updateAttribute("automatic_discussion_options",t),r().modal.close()}})}},r().translator.trans(hi+"auto-discussion-options"))]):null]},e.accessTab=function(t){var i=this,e="standalone"===t.type()||t.isAutoLink();return[m(_t,{validationErrors:this.validationErrors.accept_submissions},bt().component({state:t.accept_submissions(),onchange:this.updateAttribute.bind(this,"accept_submissions"),disabled:this.loading},r().translator.trans(hi+"field."+("standalone"===t.type()?"accept-submissions":"enable")))),"standalone"===t.type()?m(_t,{validationErrors:this.validationErrors.allow_modification},bt().component({state:t.allow_modification(),onchange:this.updateAttribute.bind(this,"allow_modification"),disabled:this.loading},r().translator.trans(hi+"field.allow-modification"))):null,e?m(_t,{validationErrors:this.validationErrors.max_submissions,label:m("label",r().translator.trans(hi+"field.max-submissions"))},m("input.FormControl",{type:"number",value:t.max_submissions(),oninput:M()("value",(function(t){i.updateAttribute("max_submissions",t)})),disabled:this.loading})):null,"standalone"!==t.type()?[m("h2",r().translator.trans(hi+"section.permissions")),m(_t,{className:"FormulairePermissionFormGroup",validationErrors:this.validationErrors.permission_see_own,label:m("label",r().translator.trans(hi+"field.permission-see-own"))},ut.component({groupIds:t.permission_see_own(),onchange:this.updateAttribute.bind(this,"permission_see_own"),disabled:this.loading,allowGuest:"user"===t.type(),guestMeansDisabled:!0})),m(_t,{className:"FormulairePermissionFormGroup",validationErrors:this.validationErrors.permission_see_any,label:m("label",r().translator.trans(hi+"field.permission-see-any"))},ut.component({groupIds:t.permission_see_any(),onchange:this.updateAttribute.bind(this,"permission_see_any"),disabled:this.loading,allowGuest:!0})),m(_t,{className:"FormulairePermissionFormGroup",validationErrors:this.validationErrors.permission_edit_own,label:m("label",r().translator.trans(hi+"field.permission-edit-own"))},ut.component({groupIds:t.permission_edit_own(),onchange:this.updateAttribute.bind(this,"permission_edit_own"),disabled:this.loading,allowGuest:"user"===t.type(),guestMeansDisabled:!0})),m(_t,{className:"FormulairePermissionFormGroup",validationErrors:this.validationErrors.permission_edit_any,label:m("label",r().translator.trans(hi+"field.permission-edit-any"))},ut.component({groupIds:t.permission_edit_any(),onchange:this.updateAttribute.bind(this,"permission_edit_any"),disabled:this.loading}))]:null]},e.notificationsTab=function(t){var i=this;return[m(".Form-group",[bt().component({state:t.send_confirmation_to_participants(),onchange:this.updateAttribute.bind(this,"send_confirmation_to_participants"),disabled:this.loading},r().translator.trans(hi+"field.send-confirmation-to-participants")),_().component({className:"Button",disabled:!t.send_confirmation_to_participants(),onclick:function(){r().modal.show(ui,{title:t.email_confirmation_title(),message:t.email_confirmation_message(),onchange:function(t,e){i.updateAttribute("email_confirmation_title",t),i.updateAttribute("email_confirmation_message",e),r().modal.close()}})}},r().translator.trans(hi+"email-confirmation-options"))]),m(_t,{validationErrors:this.validationErrors.notify_emails,label:m("label",r().translator.trans(hi+"field.notify-emails"))},[m("input.FormControl",{type:"text",value:t.notify_emails(),oninput:M()("value",(function(t){i.updateAttribute("notify_emails",t)})),disabled:this.loading}),_().component({className:"Button",disabled:!t.notify_emails(),onclick:function(){r().modal.show(ui,{title:t.email_notification_title(),message:t.email_notification_message(),onchange:function(t,e){i.updateAttribute("email_notification_title",t),i.updateAttribute("email_notification_message",e),r().modal.close()}})}},r().translator.trans(hi+"email-notification-options"))]),m(_t,{validationErrors:this.validationErrors.web_confirmation_message,label:m("label",r().translator.trans(hi+"field.web-confirmation-message"))},m(St,{value:t.web_confirmation_message(),onchange:M()("value",(function(t){i.updateAttribute("web_confirmation_message",t)})),disabled:this.loading}))]},e.exportTab=function(t){var i=this;return[m(_t,{label:m("label","Import/Export (you must refresh the page before copying for the latest version)")},m("textarea.FormControl",{value:JSON.stringify(t.template(),null,4),oninput:M()("value",(function(t){try{i.history.value=JSON.parse(t),i.history.save(),i.dirty=!0}catch(t){alert("Invalid JSON")}})),disabled:this.loading}))]},e.updateAttribute=function(t,i){var e;this.form&&("title"===t&&this.form.title()===this.form.private_title()&&this.form.pushAttributes({private_title:i}),this.form.pushAttributes(((e={})[t]=i,e)),this.dirty=!0,delete this.validationErrors[t])},e.warnings=function(t){var i=[],e=function(i,e){var o=t["permission_"+i]();return null!==o?o:r().forum.attribute("formulaireGlobalPermissions")[e]};function o(t,i){return Array.isArray(t)&&-1===t.indexOf(i)}if("standalone"!==t.type()&&t.show_on_creation())if("user"===t.type()){var n=e("see_own","formulaire.seeOwnUser"),a=e("edit_own","formulaire.editOwnUser");(o(n,ot().GUEST_ID)||o(a,ot().GUEST_ID))&&i.push(r().translator.trans(hi+"warnings.show-on-signup-invalid-permissions"))}else{var s=e("see_own","discussion.seeOwnFormulaire"),l=e("edit_own","discussion.editOwnFormulaire");(o(s,ot().MEMBER_ID)||o(l,ot().MEMBER_ID))&&i.push(r().translator.trans(hi+"warnings.show-on-composer-invalid-permissions"))}return"standalone"===t.type()||t.accept_submissions()||i.push(r().translator.trans(hi+"warnings.linked-form-is-draft")),t.isAutoLink()&&i.push(r().translator.trans(hi+"warnings.auto-link-permission-warning")),i},e.loadTagsIfNecessary=function(){var t=this;"placement"===this.tab&&this.form&&"tags"===this.form.link_type()&&!this.tagsLoaded&&"flarum-tags"in flarum.extensions&&(r().tagList?(this.tagsLoading=!0,r().tagList.load(["parent"]).then((function(){t.tagsLoading=!1,t.tagsLoaded=!0,m.redraw()}))):console.warn("[formulaire] Cannot load tag list"))},i}(Yt);const gi=flarum.core.compat["common/helpers/avatar"];var vi=t.n(gi);const bi=flarum.core.compat["common/helpers/username"];var yi=t.n(bi),wi=function(){function t(t){void 0===t&&(t={}),this.params=void 0,this.submissions=[],this.moreResults=!1,this.loading=!0,this.params=t}var i=t.prototype;return i.requestParams=function(){var t={filter:{}};return t.sort=this.sortMap()[this.params.sort],this.params.q&&(t.filter.q=this.params.q),t},i.sortMap=function(){return{latest:"-createdAt",oldest:"createdAt"}},i.clear=function(){this.submissions=[],m.redraw()},i.refresh=function(t){var i=this,e=(void 0===t?{}:t).deferClear,r=void 0!==e&&e;return this.loading=!0,r||this.clear(),this.loadResults().then((function(t){i.submissions=[],i.parseResults(t)}),(function(){i.loading=!1,m.redraw()}))},i.loadResults=function(t){void 0===t&&(t=0);var i=r().preloadedApiDocument();if(i)return Promise.resolve(i);var e=this.requestParams();return e.page={offset:t},r().store.find("formulaire/submissions",e)},i.loadMore=function(){this.loading=!0,this.loadResults(this.submissions.length).then(this.parseResults.bind(this))},i.parseResults=function(t){var i;return(i=this.submissions).push.apply(i,t),this.loading=!1,this.moreResults=!!t.payload.links&&!!t.payload.links.next,m.redraw(),t},t}(),Fi=function(){function t(){}return t.prototype.view=function(t){var i={};["latest","oldest"].forEach((function(t){i[t]=Q()(r().translator.trans("kilowhat-formulaire.forum.submission-sort."+t))}));var e=t.attrs.sort||Object.keys(i)[0];return m(X(),{buttonClassName:"Button",label:i[t.attrs.sort]||Object.keys(i).map((function(t){return i[t]}))[0],icon:"fas fa-sort-amount-"+("latest"===e?"up":"down")},Object.keys(i).map((function(r){var o=i[r],n=e===r;return m(_(),{icon:!n||"fas fa-check",onclick:function(){t.attrs.onchange(r)},active:n},o)})))},t}(),_i="kilowhat-formulaire.forum.export.",ki=["uid","user_id","user_username","user_displayname","link_id","locked_at","created_at","updated_at","hidden_at"],xi=["uid","user_username","created_at"];function Ei(t){return m(".FormulaireExportModal-code",[m("pre.numbers",t.split("\n").map((function(t,i){return i+1})).join("\n")),m("pre.content",t)])}var Ci=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).format="xlsx",i.heading="title",i.fields=null,i.meta=null,i.showAllMeta=!1,i.optionKeys=!1,i.loadingPreview=!1,i.preview=null,i}a(i,t);var e=i.prototype;return e.className=function(){return"FormulaireModal FormulaireTheme FormulaireExportModal Modal--large"},e.title=function(){return r().translator.trans(_i+"title")},e.oninit=function(i){t.prototype.oninit.call(this,i),this.updatePreview()},e.content=function(){var t=this,i=this.attrs.form,e=[].concat(ki);return i.attribute("canExportUserDetails")&&e.splice(4,0,"user_email","user_activated"),m(".FormulaireExportModal-row",[m(".FormulaireExportModal-config.Modal-body",[m(".Form-group",m("a",{className:"Button Button--primary Button--block hasIcon",download:i.private_title()+"."+this.format,href:this.generateUrl()},[m("i.icon.fas.fa-file-download.Button-icon"),m("span.Button-label",r().translator.trans(_i+"submit"))])),m(".Form-group",[m("label",r().translator.trans(_i+"format")),wt().component({value:this.format,onchange:function(i){t.format=i,t.updatePreview()},options:{xlsx:r().translator.trans(_i+"format-options.xlsx"),xls:r().translator.trans(_i+"format-options.xls"),ods:r().translator.trans(_i+"format-options.ods"),csv:r().translator.trans(_i+"format-options.csv"),json:r().translator.trans(_i+"format-options.json")}})]),m(".Form-group",[m("label",r().translator.trans(_i+"heading")),wt().component({value:this.heading,onchange:function(i){t.heading=i,t.updatePreview()},options:{title:r().translator.trans(_i+"heading-options.title"),key:r().translator.trans(_i+"heading-options.key"),none:r().translator.trans(_i+"heading-options.none")}})]),m(".Form-group",[m("label",r().translator.trans(_i+"fields")),Array.isArray(i.template())?i.template().map((function(e){var r=null===t.fields||-1!==t.fields.indexOf(e.key);return m("div",m("label",[m("input",{type:"checkbox",checked:r,onchange:function(){null===t.fields&&(t.fields=i.template().map((function(t){return t.key}))),r?t.fields=t.fields.filter((function(t){return t!==e.key})):t.fields.push(e.key),t.fields.length===i.template().length&&(t.fields=null),t.updatePreview()}})," ",e.title||e.key]))})):null]),m(".Form-group",[m("label",r().translator.trans(_i+"meta")),e.map((function(i){if(!t.showAllMeta&&-1===xi.indexOf(i))return null;var e=null===t.meta&&-1!==xi.indexOf(i)||Array.isArray(t.meta)&&-1!==t.meta.indexOf(i);return m("div",m("label",[m("input",{type:"checkbox",checked:e,onchange:function(){null===t.meta&&(t.meta=xi.slice()),e?t.meta=t.meta.filter((function(t){return t!==i})):t.meta.push(i),t.meta.length===xi.length&&t.meta.every((function(t){return-1!==xi.indexOf(t)}))&&(t.meta=null),t.updatePreview()}})," ",r().translator.trans(_i+"meta-options."+i)]))})),this.showAllMeta?null:m("div",m("a",{href:"#",onclick:function(i){i.preventDefault(),t.showAllMeta=!0}},r().translator.trans(_i+"more-meta")))]),m(".Form-group",m("label",[m("input",{type:"checkbox",checked:this.optionKeys,onchange:function(){t.optionKeys=!t.optionKeys,t.updatePreview()}})," ",r().translator.trans(_i+"option-keys")]))]),m(".FormulaireExportModal-preview",[m("h3",r().translator.trans(_i+"preview")),this.viewPreview()])])},e.viewPreview=function(){if(this.loadingPreview||!this.preview)return C().component({className:"LoadingIndicator--block"});if("json"===this.preview.format)return Ei(JSON.stringify(JSON.parse(this.preview.data),null,2));if("csv"===this.preview.format)return Ei(this.preview.data);var t=JSON.parse(this.preview.data);return t.length?m("table",m("tbody",[m("tr",[m("th"),t[0].map((function(t,i){return m("th",String.fromCharCode(65+i))}))]),t.map((function(t,i){return m("tr",[m("th",i+1),t.map((function(t){var i=t;return!0===t?i=r().translator.trans(_i+"preview-primitives.boolean-true"):!1===t?i=r().translator.trans(_i+"preview-primitives.boolean-false"):"number"==typeof t&&Math.round(1e4*t)!==10*Math.round(1e3*t)&&(i=r().translator.trans(_i+"preview-primitives.excel-date")),m("td",i)}))])}))])):"empty result set"},e.generateUrl=function(t){void 0===t&&(t=!1);var i={};null!==this.fields&&(i.fields=this.fields.join(",")),null!==this.meta&&(i.meta=this.meta.join(",")),"title"!==this.heading&&(i.heading=this.heading),this.optionKeys&&(i.optionKeys=1),t&&(i.preview=1);var e=m.buildQueryString(i);return r().forum.attribute("apiUrl")+this.attrs.form.apiEndpoint()+"/export."+this.format+(e?"?"+e:"")},e.updatePreview=function(){var t=this;this.loadingPreview=!0,m.redraw();var i=this.format;m.request({method:"GET",url:this.generateUrl(!0),extract:function(t){var i=t.status;if(i<200||i>299)throw new(zt())(i,t.responseText,{},t);return t.responseText}}).then((function(e){t.loadingPreview=!1,t.preview={format:i,data:e},m.redraw()})).catch((function(i){throw t.loadingPreview=!1,t.preview=null,m.redraw(),i}))},i}(D()),Si="kilowhat-formulaire.forum.submission-index.",Ii=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).submissionList=void 0,i}a(i,t);var e=i.prototype;return e.oninit=function(i){t.prototype.oninit.call(this,i),this.submissionList=new wi({q:"form:"+m.route.param("id")}),this.submissionList.refresh()},e.content=function(t){var i=this;return m(W,[m(fi,{form:t,changeTab:function(i){r().cache.formulaireFormEditTab=i,m.route.set(R(t))},isSubmissionPage:!0}),m(".FormulaireFilters",[m(Fi,{sort:this.submissionList.params.sort,onchange:function(t){i.submissionList.params.sort=t,i.submissionList.refresh()}}),r().forum.attribute("formulaireCanSearchSubmissions")?m(ct,{initialValue:"",onchange:function(t){i.submissionList.params.q="form:"+m.route.param("id")+" "+t,i.submissionList.refresh()},placeholder:r().translator.trans(Si+"search")}):null,"standalone"===t.type()?x().component({className:"Button FormulaireFilters--right",href:B(this.form)},r().translator.trans(Si+"form-show")):null,t.attribute("canExport")?_().component({className:"Button Button--primary"+("standalone"===t.type()?"":" FormulaireFilters--right"),onclick:function(){r().modal.show(Ci,{form:i.form})},icon:"fas fa-file-export"},r().translator.trans(Si+"export")):null]),this.list(this.submissionList)])},e.list=function(t){var i;return t.loading?i=C().component():t.moreResults&&(i=_().component({className:"Button",onclick:t.loadMore.bind(t)},r().translator.trans(Si+"load-more"))),0!==t.submissions.length||t.loading?m("div",[m("table.FormulaireDataTable",[m("thead",m("tr",[m("th",r().translator.trans(Si+"columns.date")),m("th",r().translator.trans(Si+"columns.user")),m("th",r().translator.trans(Si+"columns.actions"))])),m("tbody",t.submissions.map((function(t){var i=t.user(),e=t.badges().toArray();return m("tr",[m("td",[t.createdAt(),e.length?m("ul.FormulaireDataTable-badges.badges",N()(e)):null]),m("td",i?[vi()(i),yi()(i)]:r().translator.trans(Si+"guest")),m("td",[x().component({className:"Button",href:V(t)},r().translator.trans(Si+"show"))])])})))]),i]):I().component({text:r().translator.trans(Si+"empty")})},i}(Yt),Ai="kilowhat-formulaire.forum.submission.",Ni=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).locking=!1,i.restoring=!1,i.deleting=!1,i.submission=null,i.uploader=void 0,i.history=void 0,i}a(i,t);var e=i.prototype;return e.oninit=function(i){var e=this;t.prototype.oninit.call(this,i),this.errorPage=null;var o=m.route.param("id"),n=r().preloadedApiDocument();if(n)this.show(n);else{var a=r().store.getById("formulaire-submissions",o);a&&a.form()?this.show(a):r().store.find("formulaire/submissions",o,{},{errorHandler:this.pageLoadErrorHandler.bind(this)}).then((function(t){e.show(t),m.redraw()}))}},e.onremove=function(i){t.prototype.onremove.call(this,i),delete document.body.dataset.formulaireFormId,delete document.body.dataset.formulaireSubmissionId},e.show=function(t){var i=t.form();if(!i)throw"Missing form relationship";this.submission=t,this.uploader=new ei(i),this.history=new jt(t.formData()),document.body.dataset.formulaireFormId=i.id(),document.body.dataset.formulaireSubmissionId=t.id()},e.view=function(){var t=this;if(this.errorPage)return m(W,{showSideNav:r().forum.attribute("formulaireShowSideNavOnSubmission"),narrow:!0},m(Xt,{error:this.errorPage}));if(!this.submission)return C().component({className:"LoadingIndicator--block"});var i=this.submission.form();if(!i)throw"Missing form relationship";var e=new Ut({configs:i.template(),submission:this.history.value,uploader:this.uploader,onchange:function(){t.history.save(),t.dirty=!0},disabled:this.loading||this.uploader.uploading,validationErrors:this.validationErrors}),o=this.submission.badges().toArray(),n=this.controls(this.submission).toArray();return m(W,{showSideNav:r().forum.attribute("formulaireShowSideNavOnSubmission"),narrow:!0},[m("h2",[i.title(),o.length?m("ul.FormulaireDataTable-badges.badges",N()(o)):null]),n.length?m(".Form-group",n):null,this.submission.attribute("canEdit")?null:m("p",r().translator.trans(Ai+"edit-forbidden")),m("div",{className:ri(this.submission.attribute("canEdit")?"StandaloneEdit":"SubmissionView")?"Formulaire-horizontal-layout":""},e.listView(!this.submission.attribute("canEdit"))),m(ti,{dirty:this.dirty,loading:this.loading,savedAt:this.savedAt,inError:Object.keys(this.validationErrors).length,history:r().forum.attribute("formulaireShowHistoryControls")?this.history:null,onsave:function(){t.loading=!0,t.submission.save({data:t.history.value},{errorHandler:t.onerror.bind(t)}).then((function(){t.loading=!1,t.dirty=!1,t.savedAt=new Date,t.validationErrors={},t.history.clear(),m.redraw()}))},floating:!0})])},e.controls=function(t){var i=this,e=new(h());return t.attribute("canLock")&&e.add("lock",_().component({className:"Button",loading:this.locking,onclick:function(){i.locking=!0,t.save({isLocked:!t.isLocked()}).then((function(){i.locking=!1,m.redraw()})).catch((function(t){throw i.locking=!1,m.redraw(),t}))}},r().translator.trans(Ai+(t.isLocked()?"unlock":"lock")))),t.isHidden()&&t.attribute("canRestore")&&e.add("hide",_().component({className:"Button",loading:this.restoring,onclick:function(){i.restoring=!0,t.save({isHidden:!1}).then((function(){i.restoring=!1,m.redraw()})).catch((function(t){throw i.restoring=!1,m.redraw(),t}))}},r().translator.trans(Ai+"restore"))),!t.isHidden()&&t.attribute("canHide")&&e.add("hide",_().component({className:"Button",loading:this.deleting,onclick:function(){i.deleting=!0,t.save({isHidden:!0}).then((function(){i.deleting=!1,m.redraw()})).catch((function(t){throw i.deleting=!1,m.redraw(),t}))}},r().translator.trans(Ai+"hide"))),t.isHidden()&&t.attribute("canDelete")&&e.add("delete",_().component({className:"Button",loading:this.deleting,onclick:function(){confirm(Q()(r().translator.trans(Ai+"delete-confirmation",{date:t.createdAt()})))&&(i.deleting=!0,t.delete().then((function(){i.deleting=!1,m.redraw();var e=t.form();e&&m.route.set(H(e))})).catch((function(t){throw i.deleting=!1,m.redraw(),t})))}},r().translator.trans(Ai+"delete"))),e},i}(Kt),Pi=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).configuration=void 0,i.submission=void 0,i.errors=void 0,i.history=null,i.horizontal=!1,i}a(i,t);var e=i.prototype;return e.oninit=function(i){var e=this;t.prototype.oninit.call(this,i),m.request({url:r().forum.attribute("apiUrl")+"/formulaire/debug",method:"GET"}).then((function(t){e.configuration=t.configuration,e.submission=t.submission,e.errors=t.errors,t.store.forEach((function(t){r().store.pushObject(t)})),e.history=new jt(e.configuration)}))},e.view=function(){var t=this;if(!this.history)return m("i","...");var i=new Ut({configs:this.history.value,submission:this.submission,uploader:{uploading:!1},onchange:function(){t.history.save()},expertMode:!0,validationErrors:this.errors});return m(".FormulaireDebugPage",{className:this.horizontal?"Formulaire-horizontal-layout":""},[m("div",[bt().component({state:this.horizontal,onchange:function(i){t.horizontal=i}},"Horizontal"),m("pre",JSON.stringify(this.history.value,null,4)),m("pre",JSON.stringify(this.submission,null,4))]),m("div",[i.configureView(),m(ti,{history:this.history,floating:!0})]),m("div",i.listView()),m("div",i.listView(!0))])},i}(w());const Ti=flarum.core.compat["forum/components/UserPage"];var Oi=t.n(Ti),Di=function(){function t(){this.uploader=void 0,this.history=void 0,this.dirty=!1,this.loading=!1,this.savedAt=null,this.validationErrors={}}var i=t.prototype;return i.oninit=function(t){var i=t.attrs,e=i.form,r=i.linked.formulaireSubmissions(),o=r?r.find((function(t){var i=t.form();return i&&i.id()===e.id()})):null;this.uploader=new ei(e),this.history=new jt(o?o.formData():{})},i.view=function(t){var i=this,e=t.attrs,o=e.form,n=e.linked,a=new Ut({configs:o.template(),submission:this.history.value,uploader:this.uploader,onchange:function(){i.history.save(),i.dirty=!0},disabled:this.loading||this.uploader.uploading,validationErrors:(this.validationErrors.formulaireForms||{})[o.id()]}),s=!o.attribute("canSubmit");return m(".FormulaireLinkedForm",{className:t.attrs.className},[a.listView(s),m(ti,{dirty:this.dirty,loading:this.loading,savedAt:this.savedAt,inError:Object.keys(this.validationErrors).length>0,history:r().forum.attribute("formulaireShowHistoryControls")?this.history:null,floating:void 0===t.attrs.floating||t.attrs.floating,onsave:function(){i.loading=!0,n.save({relationships:{formulaireForms:[{verbatim:!0,type:"formulaire-forms",id:o.id(),attributes:{data:i.history.value}}]}},{errorHandler:i.onerror.bind(i)}).then((function(){i.loading=!1,i.dirty=!1,i.savedAt=new Date,i.validationErrors={},i.history.clear(),m.redraw()})).catch((function(t){throw i.loading=!1,m.redraw(),t}))}})])},i.onerror=function(t){var i;this.loading=!1;var e=!1;if(422===t.status&&null!=(i=t.response)&&i.errors&&(e=!0,this.validationErrors=Jt(t)),m.redraw(),!e)throw t},t}(),Li=function(t){function i(){for(var i,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(i=t.call.apply(t,[this].concat(r))||this).form=null,i}a(i,t);var e=i.prototype;return e.oninit=function(i){t.prototype.oninit.call(this,i),this.loadUser(m.route.param("username"))},e.show=function(i){var e=m.route.param("form");this.form=r().store.getBy("formulaire-forms","seoId",e)||null,t.prototype.show.call(this,i)},e.content=function(){return this.form?m(Di,{key:this.form.id(),form:this.form,linked:this.user,className:ri(this.form.attribute("canSubmit")?"ProfileEdit":"ProfileView")?"Formulaire-horizontal-layout":""}):C().component()},i}(Oi());const Mi=flarum.core.compat["common/extend"],Bi=flarum.core.compat["forum/components/DiscussionComposer"];var Ri=t.n(Bi);const Hi=flarum.core.compat["forum/states/ComposerState"];var Vi=t.n(Hi);const qi=flarum.core.compat["common/models/Discussion"];var Ui=t.n(qi),ji=["formulaireSaveOptions"];function Gi(t,i){if(!t.link_id())return!0;var e=i.fields.tags;return!!Array.isArray(e)&&e.some((function(i){return i.id()==t.link_id()}))}const zi=flarum.core.compat["forum/components/CommentPost"];var Wi=t.n(zi),Ji=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var e=i.prototype;return e.className=function(){return"FormulaireModal FormulaireTheme Modal--large"},e.title=function(){return this.attrs.form.title()},e.content=function(){return m(".Modal-body",m(Di,{form:this.attrs.form,linked:this.attrs.discussion,floating:!1,className:ri("DiscussionEdit")?"Formulaire-horizontal-layout":""}))},e.onsubmit=function(t){t.preventDefault()},i}(D()),Ki=function(){function t(){}var i=t.prototype;return i.view=function(t){var i=t.attrs,e=i.form,o=i.discussion,n=o.formulaireSubmissions(),a=n?n.find((function(t){var i=t.form();return i&&i.id()===e.id()})):null;return m(".FormulaireDiscussionForms",{className:ri("DiscussionView")?"Formulaire-horizontal-layout":""},[m("h3",e.title()),e.attribute("canSubmit")?_().component({onclick:function(){r().modal.show(Ji,{form:e,discussion:o})},className:"Button Button--icon",icon:"fas fa-pen",title:Q()(r().translator.trans("kilowhat-formulaire.forum.discussion-submission.edit"))}):null,this.submissionView(e,a)])},i.submissionView=function(t,i){return i?new Ut({configs:t.template(),submission:i.formData()}).listView(!0):m("p",r().translator.trans("kilowhat-formulaire.forum.discussion-submission.empty"))},t}();function Xi(t){return 1===t.number()}var Yi=["formulaireFormIndex","formulaireFormIndexDiscussion","formulaireFormIndexUser","formulaireFormEdit","formulaireSubmissionIndex"],Qi=function(t){function i(){return t.apply(this,arguments)||this}return a(i,t),i.initAttrs=function(i){t.initAttrs.call(this,i),i.active=this.isActive(i),i.icon="fas fa-poll-h",i.href=r().route("formulaireFormIndex")},i.prototype.getButtonContent=function(){return t.prototype.getButtonContent.call(this,r().translator.trans("kilowhat-formulaire.forum.nav.forms"))},i.isActive=function(t){return m.route.get()===t.href||-1!==Yi.indexOf(r().current.data.routeName)},i}(x());const Zi=flarum.core.compat["forum/components/SignUpModal"];var $i=t.n(Zi);const te=flarum.core.compat["common/utils/BasicEditorDriver"];var ie=t.n(te),ee={DiscreetInput:mi,DiscussionSubmission:Ki,ErrorPage:Xt,FormEditHeader:fi,FormGroup:_t,FormSortDropdown:Z,FormTitle:ii,GlobalSettings:dt,LinkedFormFill:Di,PageContainer:W,PermissionDropdown:ut,RichTextField:St,SaveControls:ti,SettingsLinkButton:Qi,Sortable:gt,SortableHandle:kt,SubmissionSortDropdown:Fi,ValidationErrors:Ft},re={Content:It,Date:At,Field:Et,FieldList:Ut,Items:Pt,LongAnswer:Tt,Number:Ot,ShortAnswer:Mt,typeMap:Ht,Upload:Rt},oe={AbstractFormPage:Yt,AbstractProcessingPage:Kt,DebugPage:Pi,FormEditPage:pi,FormIndexPage:pt,FormShowPage:ni,ProfilePage:Li,SubmissionIndexPage:Ii,SubmissionPage:Ni},ne=[new o.Extend.Model("formulaire-files",u),new o.Extend.Model("formulaire-forms",v),new o.Extend.Model("formulaire-submissions",b),new o.Extend.Model("forums").attribute("formulaireCanManage").hasMany("formulaireSignUpForms").hasMany("formulaireComposerForms"),new o.Extend.Model("discussions").hasMany("formulaireForms").hasMany("formulaireSubmissions"),new o.Extend.Model("users").hasMany("formulaireForms").hasMany("formulaireSubmissions"),(new o.Extend.Routes).add("formulaireFormIndex","/formulaire",pt).add("formulaireFormIndexDiscussion","/formulaire/discussion",pt).add("formulaireFormIndexUser","/formulaire/user",pt).add("formulaireFormShow","/forms/:id",ni).add("formulaireFormEdit","/formulaire/:id",pi).add("formulaireSubmissionIndex","/formulaire/:id/submissions",Ii).add("formulaireSubmission","/submissions/:id",Ni).add("formulaireDebug","/formulaire-debug",Pi).add("formulaireProfile","/u/:username/forms/:form",Li)];r().initializers.add("kilowhat-formulaire",(function(){(0,Mi.extend)(z().prototype,"navItems",(function(t){r().forum.attribute("formulaireCanManage")&&t.add("formulaire",Qi.component())})),(0,Mi.extend)(Oi().prototype,"navItems",(function(t){var i=this,e=this.user.formulaireForms();e&&e.forEach((function(e){t.add("formulaire-"+e.id(),x().component({icon:"fas fa-poll-h",href:q(i.user,e)},e.title()))}))})),(0,Mi.extend)(Ri().prototype,"oninit",(function(){var t=this;this.formulaireValidationErrors={},this.formulaireRequestErrorAlert=null,this.composer.fields.formulaire||(this.composer.fields.formulaire={},(r().forum.formulaireComposerForms()||[]).forEach((function(i){t.composer.fields.formulaire[i.id()]={value:{},uploader:new ei(i)}})))})),(0,Mi.extend)(Ri(),"initAttrs",(function(t,i){ri("DiscussionComposer")&&(i.className+=" Formulaire-horizontal-layout")})),(0,Mi.extend)(Ri().prototype,"headerItems",(function(t){var i=this,e=r().forum.formulaireComposerForms()||[],o=[];e.forEach((function(t){if(Gi(t,i.composer)){var e=i.composer.fields.formulaire[t.id()],r=new Ut({configs:t.template(),submission:e.value,uploader:e.uploader,disabled:i.loading||e.uploader.uploading,validationErrors:(i.formulaireValidationErrors.formulaireForms||{})[t.id()]});o.push(r.listView())}})),o.length&&t.add("formulaire",m(".FormulaireDiscussionComposer",o))})),(0,Mi.extend)(Ri().prototype,"data",(function(t){var i=this;this.formulaireValidationErrors={},null!==this.formulaireRequestErrorAlert&&r().alerts.dismiss(this.formulaireRequestErrorAlert);var e=r().forum.formulaireComposerForms()||[],o=[];e.forEach((function(t){Gi(t,i.composer)&&o.push({verbatim:!0,id:t.id(),attributes:{data:i.composer.fields.formulaire[t.id()].value}})})),o.length&&(t.relationships=t.relationships||{},t.relationships.formulaireForms=o,t.formulaireSaveOptions={errorHandler:function(t){422===t.status&&t.response.errors&&(i.formulaireValidationErrors=Jt(t)),m.redraw(),t.alert&&(i.formulaireRequestErrorAlert=r().alerts.show(t.alert,t.alert.content))}})})),(0,Mi.override)(Vi().prototype,"minimumHeight",(function(t){var i=this,e=t();if(!this.bodyMatches(Ri()))return e;var o=r().forum.formulaireComposerForms()||[],n=0;return o.forEach((function(t){if(Gi(t,i)){var e=t.template();e&&e.forEach((function(t){switch(t.type){case"items":case"upload":n+=120;break;case"checkbox":case"radio":n+=36*(t.options||[]).length,t.other&&(n+=36);break;default:n+=36}ri("DiscussionComposer")||(n+=31),n+=10}))}})),e+Math.min(n,500)})),(0,Mi.override)(Ui().prototype,"save",(function(t,i,e){void 0===e&&(e={});var r=i.formulaireSaveOptions;return t(function(t,i){if(null==t)return{};var e,r,o={},n=Object.keys(t);for(r=0;r<n.length;r++)e=n[r],i.indexOf(e)>=0||(o[e]=t[e]);return o}(i,ji),tt({},e,r||{}))})),(0,Mi.extend)(Wi().prototype,"oninit",(function(){var t=this;Xi(this.attrs.post)&&this.subtree.check((function(){var i=t.attrs.post.discussion().formulaireSubmissions();return i?i.map((function(t){return JSON.stringify(t.formData())})).join(","):""}))})),(0,Mi.extend)(Wi().prototype,"content",(function(t){var i=this.attrs.post;if(Xi(i)){var e=i.discussion().formulaireForms();if(e){var r=t.findIndex((function(t){return t&&t.attrs&&"Post-header"===t.attrs.className}));t.splice(-1===r?0:r+1,0,e.map((function(t){return m(Ki,{form:t,discussion:i.discussion()})})))}}})),r().route.formulaireFormShow=B,r().route.formulaireFormEdit=R,r().route.formulaireSubmissionIndex=H,r().route.formulaireSubmission=V,r().route.formulaireProfile=q,(0,Mi.extend)($i().prototype,"oninit",(function(){var t=this,i=r().forum.formulaireSignUpForms()||[];this.formulaire={},this.formulaireValidationErrors={},i.forEach((function(i){t.formulaire[i.id()]={value:{},uploader:new ei(i)}}))})),(0,Mi.extend)($i().prototype,"fields",(function(t){var i=this;(r().forum.formulaireSignUpForms()||[]).forEach((function(e){var r=i.formulaire[e.id()],o=new Ut({configs:e.template(),submission:r.value,uploader:r.uploader,disabled:i.loading||r.uploader.uploading,validationErrors:(i.formulaireValidationErrors.formulaireForms||{})[e.id()]});t.add("formulaire-"+e.seoId(),m(".FormulaireSignUpForm",{className:ri("SignUp")?"Formulaire-horizontal-layout":""},o.listView()))}))})),(0,Mi.extend)($i().prototype,"submitData",(function(t){var i=this;(r().forum.formulaireSignUpForms()||[]).forEach((function(e){t.formulaireForms||(t.formulaireForms=[]),t.formulaireForms.push({id:e.id(),attributes:{data:i.formulaire[e.id()].value}})}))})),(0,Mi.override)($i().prototype,"onerror",(function(t,i){var e;return 422===i.status&&null!=(e=i.response)&&e.errors&&(this.formulaireValidationErrors=Jt(i)),t(i)})),(0,Mi.override)(l(),"getIdentifier",(function(t,i){return i.verbatim?(delete i.verbatim,i):t(i)}))})),r().initializers.add("kilowhat-formulaire-delayed",(function(){(0,Mi.extend)(Ri(),"initAttrs",(function(t,i){r().forum.attribute("formulaireUniformComposerLayout")&&(i.className+=" Formulaire-uniform-layout")})),(0,Mi.extend)(Ri().prototype,"headerItems",(function(t){var i=this;if(r().forum.attribute("formulaireUniformComposerLayout")){if(t.has("tags")){var e=t.get("tags");t.setContent("tags",m(_t,{label:m("label",r().translator.trans("kilowhat-formulaire.forum.discussion-composer.field.tags")),validationErrors:this.formulaireValidationErrors.tags},m(".FormControl.FormulaireTagFormControl",e)))}if(Object.keys(t.toObject()).forEach((function(e){if(0===e.indexOf("taxonomy-")){var r=t.get(e);t.setContent(e,m(_t,{label:m("label",r&&r.attrs["data-taxonomy-name"]||"?"),validationErrors:i.formulaireValidationErrors.tags},m(".FormControl.FormulaireTagFormControl",r)))}})),t.has("polls")){var o=t.get("polls");t.setContent("polls",m(_t,{label:m("label",r().translator.trans("kilowhat-formulaire.forum.discussion-composer.field.poll"))},m(".FormControl.FormulaireTagFormControl",o)))}t.setContent("discussionTitle",m(_t,{label:m("label",{for:"discussionComposerTitle"},r().translator.trans("kilowhat-formulaire.forum.discussion-composer.field.title")),validationErrors:this.formulaireValidationErrors.title},m("input#discussionComposerTitle.FormControl",{bidi:this.title,placeholder:this.attrs.titlePlaceholder,disabled:this.attrs.disabled,onkeydown:this.onkeydown.bind(this)}))),t.add("formulaireContentLabel",m(_t,{label:m("label",{for:"discussionComposerContent"},r().translator.trans("kilowhat-formulaire.forum.discussion-composer.field.content"))}),-1e4)}})),(0,Mi.extend)(ie().prototype,"build",(function(){r().forum.attribute("formulaireUniformComposerLayout")&&(this.el.id="discussionComposerContent")}))}),-100)})(),module.exports=i})();
//# sourceMappingURL=forum.js.map